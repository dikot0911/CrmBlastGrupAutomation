{% extends "admin/base.html" %}
{% block title %}God View: {{ user.username or user.email.split('@')[0] }}{% endblock %}

{% block content %}
<div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
    <div class="flex items-center gap-4">
        <a href="/super-admin/users" class="w-11 h-11 rounded-xl bg-slate-800 flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-700 transition border border-slate-700 shadow-lg">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
        <div>
            <h1 class="text-2xl font-black text-white flex items-center gap-3">
                {{ user.username or user.email.split('@')[0] }}
                {% if user.is_admin %}
                    <span class="bg-yellow-500/20 text-yellow-400 text-[10px] px-2 py-0.5 rounded border border-yellow-500/30 uppercase font-bold tracking-widest shadow-[0_0_10px_rgba(234,179,8,0.2)]">GOD ADMIN</span>
                {% endif %}
            </h1>
            <p class="text-slate-400 text-xs font-mono mt-1 flex items-center gap-2">
                <i class="fa-regular fa-envelope"></i> {{ user.email }} <span class="text-slate-600">|</span> 
                <i class="fa-solid fa-fingerprint"></i> UUID: #{{ user.id }}
            </p>
        </div>
    </div>
    <div class="flex flex-wrap gap-2">
        {% if user.is_verified %}
            <span class="bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 text-xs px-3 py-1.5 rounded-lg flex items-center gap-2 font-bold"><i class="fa-solid fa-shield-check"></i> Email Verified</span>
        {% else %}
            <span class="bg-orange-500/10 text-orange-400 border border-orange-500/20 text-xs px-3 py-1.5 rounded-lg flex items-center gap-2 font-bold"><i class="fa-solid fa-triangle-exclamation"></i> Unverified</span>
        {% endif %}
        
        {% if user.is_banned %}
            <span class="bg-red-500/20 text-red-400 border border-red-500/30 text-xs px-3 py-1.5 rounded-lg flex items-center gap-2 font-bold animate-pulse"><i class="fa-solid fa-ban"></i> BANNED</span>
        {% else %}
            <span class="bg-blue-500/10 text-blue-400 border border-blue-500/20 text-xs px-3 py-1.5 rounded-lg flex items-center gap-2 font-bold"><i class="fa-solid fa-user-check"></i> Active User</span>
        {% endif %}
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <div class="space-y-6">
        
        <div class="p-6 rounded-2xl border border-slate-700/50 bg-gradient-to-br from-slate-800/50 to-slate-900/50 backdrop-blur-sm relative overflow-hidden group">
            <div class="absolute -right-6 -top-6 bg-purple-500/10 w-24 h-24 rounded-full blur-2xl"></div>
            <h3 class="text-sm font-bold text-slate-300 uppercase mb-5 tracking-wider flex items-center gap-2">
                <i class="fa-solid fa-gem text-purple-400"></i> Subscription Control
            </h3>
            
            <div class="bg-black/20 border border-slate-700/50 p-4 rounded-xl mb-5 text-center shadow-inner">
                <p class="text-[10px] text-slate-500 mb-1 font-bold uppercase tracking-widest">Current Plan</p>
                <h2 class="text-2xl font-black text-white bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-blue-400">
                    {{ user.plan_tier|upper }}
                </h2>
                <p class="text-xs text-slate-400 mt-2 font-mono">
                    <i class="fa-regular fa-clock"></i> Exp: {{ user.subscription_end[:10] if user.subscription_end else 'Unlimited / None' }}
                </p>
            </div>

            <form action="/super-admin/update-plan/{{ user.id }}" method="POST" class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">Override Paket Ke:</label>
                    <select name="plan" class="w-full bg-slate-900 border border-slate-700 text-white text-sm rounded-xl px-4 py-3 focus:outline-none focus:border-purple-500 transition cursor-pointer font-bold">
                        <option value="Starter" {{ 'selected' if user.plan_tier == 'Starter' }}>Starter (Free)</option>
                        <option value="UMKM PRO" {{ 'selected' if user.plan_tier == 'UMKM PRO' }}>UMKM PRO</option>
                        <option value="Agency" {{ 'selected' if user.plan_tier == 'Agency' }}>Agency</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">Durasi Tambahan (Hari):</label>
                    <input type="number" name="days" value="30" class="w-full bg-slate-900 border border-slate-700 text-white text-sm rounded-xl px-4 py-3 focus:outline-none focus:border-purple-500 transition font-mono">
                </div>
                <button type="submit" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-black py-3 rounded-xl text-xs transition uppercase tracking-widest shadow-lg shadow-purple-900/20 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Inject Paket
                </button>
            </form>
        </div>

        <div class="p-6 rounded-2xl border border-yellow-900/30 bg-gradient-to-br from-slate-800/50 to-slate-900/50 backdrop-blur-sm relative overflow-hidden group">
            <div class="absolute -right-6 -top-6 bg-yellow-500/10 w-24 h-24 rounded-full blur-2xl"></div>
            <h3 class="text-sm font-bold text-yellow-500 uppercase mb-5 tracking-wider flex items-center gap-2">
                <i class="fa-solid fa-key"></i> Force Reset Password
            </h3>
            
            <form action="/super-admin/reset-password/{{ user.id }}" method="POST" class="space-y-4" onsubmit="return confirm('⚠️ PERINGATAN: Password user akan diganti paksa. Lanjutkan?')">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">Set Password Baru:</label>
                    <div class="relative">
                        <input type="text" name="new_password" id="forcePassword" placeholder="Contoh: AdminTampan123!" required class="w-full bg-slate-900 border border-slate-700 text-white text-sm rounded-xl pl-4 pr-12 py-3 focus:outline-none focus:border-yellow-500 transition font-mono">
                        <button type="button" onclick="generateRandomPass()" class="absolute right-3 top-2.5 text-slate-400 hover:text-yellow-400 transition p-1" title="Generate Random Password">
                            <i class="fa-solid fa-dice text-lg"></i>
                        </button>
                    </div>
                    <p class="text-[10px] text-slate-500 mt-2 leading-relaxed"><i class="fa-solid fa-circle-info"></i> Sistem akan mengenkripsi (PBKDF2) password ini otomatis sebelum masuk ke database.</p>
                </div>
                <button type="submit" class="w-full bg-yellow-600/20 hover:bg-yellow-500 text-yellow-500 hover:text-slate-900 border border-yellow-600/50 hover:border-yellow-500 font-black py-3 rounded-xl text-xs transition uppercase tracking-widest flex items-center justify-center gap-2">
                    <i class="fa-solid fa-bolt"></i> Eksekusi Reset
                </button>
            </form>
        </div>

    </div>

    <div class="space-y-6">
        
        <div class="p-6 rounded-2xl border border-slate-700/50 bg-gradient-to-br from-slate-800/50 to-slate-900/50 backdrop-blur-sm relative overflow-hidden">
            <div class="absolute -right-6 -top-6 bg-blue-500/10 w-24 h-24 rounded-full blur-2xl"></div>
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-sm font-bold text-blue-400 uppercase tracking-wider flex items-center gap-2">
                    <i class="fa-brands fa-telegram text-lg"></i> Koneksi Telegram
                </h3>
                {% if tele and tele.is_active %}
                    <span class="bg-emerald-900/50 text-emerald-400 text-[10px] px-2 py-1 rounded border border-emerald-800 font-bold tracking-widest flex items-center gap-1.5 shadow-[0_0_8px_rgba(16,185,129,0.3)]">
                        <span class="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse"></span> ONLINE
                    </span>
                {% else %}
                    <span class="bg-red-900/30 text-red-400 text-[10px] px-2 py-1 rounded border border-red-800/50 font-bold tracking-widest flex items-center gap-1.5">
                        <span class="w-1.5 h-1.5 bg-red-500 rounded-full"></span> OFFLINE
                    </span>
                {% endif %}
            </div>

            {% if tele %}
                <div class="space-y-4 mb-6 bg-black/20 p-4 rounded-xl border border-slate-700/50">
                    <div class="flex flex-col border-b border-slate-700 pb-3">
                        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1">Nomor HP</span>
                        <span class="text-white font-mono text-lg">{{ tele.phone_number }}</span>
                    </div>
                    <div class="flex justify-between items-center text-sm border-b border-slate-700 pb-3">
                        <span class="text-slate-400 font-bold">First Name</span>
                        <span class="text-white font-medium">{{ tele.first_name }} {{ tele.last_name or '' }}</span>
                    </div>
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-slate-400 font-bold">Username</span>
                        <span class="text-blue-400 font-mono font-bold">@{{ tele.username or '-' }}</span>
                    </div>
                </div>

                <form action="/super-admin/reset-session/{{ user.id }}" method="POST" onsubmit="return confirm('Yakin ingin menendang/memutus koneksi bot user ini dari server?')">
                    <button type="submit" class="w-full border border-red-500/50 text-red-400 hover:bg-red-500 hover:text-white py-3 rounded-xl text-xs font-black tracking-widest transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-power-off"></i> KICK SESSION
                    </button>
                </form>
            {% else %}
                <div class="text-center py-10 bg-black/20 rounded-xl border border-slate-700/50 border-dashed">
                    <div class="w-12 h-12 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-500">
                        <i class="fa-solid fa-link-slash text-xl"></i>
                    </div>
                    <p class="text-sm font-bold text-slate-400">Belum Terhubung</p>
                    <p class="text-[10px] text-slate-500 mt-1">User ini belum scan QR Telegram.</p>
                </div>
            {% endif %}
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div class="p-4 rounded-2xl border border-slate-700/50 bg-slate-800/30 backdrop-blur-sm text-center flex flex-col items-center justify-center h-28 group hover:border-blue-500/30 transition">
                <i class="fa-solid fa-calendar-check text-slate-500 text-xl mb-2 group-hover:text-blue-400 transition"></i>
                <h3 class="text-2xl font-black text-white">{{ active_schedules }}</h3>
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">Jadwal Aktif</p>
            </div>
            <div class="p-4 rounded-2xl border border-slate-700/50 bg-slate-800/30 backdrop-blur-sm text-center flex flex-col items-center justify-center h-28 group hover:border-emerald-500/30 transition">
                <i class="fa-solid fa-address-book text-slate-500 text-xl mb-2 group-hover:text-emerald-400 transition"></i>
                <h3 class="text-2xl font-black text-white">CRM</h3>
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">Database Kontak</p>
            </div>
        </div>

    </div>

    <div class="flex flex-col space-y-6">
        
        <div class="flex-1 p-0 rounded-2xl border border-slate-700/50 bg-slate-800/30 backdrop-blur-sm overflow-hidden flex flex-col h-[400px]">
            <div class="p-5 border-b border-slate-700/80 bg-slate-900/50 flex justify-between items-center">
                <h3 class="text-sm font-bold text-slate-300 uppercase tracking-wider flex items-center gap-2">
                    <i class="fa-solid fa-terminal text-emerald-500"></i> Terminal Log
                </h3>
            </div>
            
            <div class="flex-1 overflow-y-auto p-0 custom-scrollbar bg-black/20">
                {% if logs %}
                    <table class="w-full text-left text-xs">
                        <tbody class="divide-y divide-slate-800/50">
                            {% for log in logs %}
                            <tr class="hover:bg-slate-700/20 transition">
                                <td class="px-5 py-3">
                                    <p class="text-slate-300 font-bold truncate max-w-[150px]">{{ log.group_name }}</p>
                                    <p class="text-[10px] text-slate-500 font-mono mt-0.5">{{ log.created_at[:16].replace('T', ' ') }}</p>
                                </td>
                                <td class="px-5 py-3 text-right">
                                    {% if 'SUCCESS' in log.status %}
                                        <span class="bg-emerald-500/10 text-emerald-400 px-2 py-1 rounded text-[9px] font-black border border-emerald-500/20 tracking-wider">OK</span>
                                    {% else %}
                                        <span class="bg-red-500/10 text-red-400 px-2 py-1 rounded text-[9px] font-black border border-red-500/20 tracking-wider cursor-help" title="{{ log.error_message }}">FAIL</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="h-full flex flex-col items-center justify-center text-slate-600">
                        <i class="fa-solid fa-ghost text-3xl mb-3 opacity-20"></i>
                        <p class="text-xs font-bold uppercase tracking-widest">No Activity Found</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="p-6 rounded-2xl border border-red-900/50 bg-gradient-to-br from-red-950/20 to-black/40 backdrop-blur-sm relative overflow-hidden group">
            <div class="absolute -left-6 -top-6 bg-red-600/10 w-24 h-24 rounded-full blur-2xl"></div>
            <h3 class="text-sm font-bold text-red-500 uppercase mb-4 tracking-wider flex items-center gap-2">
                <i class="fa-solid fa-skull text-lg"></i> Danger Zone
            </h3>
            
            <form action="/super-admin/ban/{{ user.id }}" method="POST" onsubmit="return confirm('Tindakan ini akan mempengaruhi akses user secara permanen. Anda yakin?')">
                {% if user.is_banned %}
                    <p class="text-[11px] text-slate-400 mb-4 leading-relaxed">User ini sedang di-banned. Mereka tidak dapat login, dan semua bot mereka telah dihentikan paksa.</p>
                    <button type="submit" class="w-full bg-emerald-600/20 hover:bg-emerald-500 text-emerald-500 hover:text-white border border-emerald-600/50 font-black tracking-widest py-3.5 rounded-xl transition flex items-center justify-center gap-2 shadow-lg">
                        <i class="fa-solid fa-unlock text-lg"></i> CABUT BANNED
                    </button>
                {% else %}
                    <p class="text-[11px] text-slate-400 mb-4 leading-relaxed">Membanned user akan langsung menendang sesi mereka dari sistem dan menghentikan seluruh tugas scheduler.</p>
                    <button type="submit" class="w-full bg-red-600/20 hover:bg-red-600 text-red-500 hover:text-white border border-red-600/50 font-black tracking-widest py-3.5 rounded-xl transition flex items-center justify-center gap-2 shadow-lg">
                        <i class="fa-solid fa-gavel text-lg"></i> BANNED USER INI
                    </button>
                {% endif %}
            </form>
        </div>

    </div>

</div>

<style>
    /* Custom Scrollbar untuk Terminal Log */
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #334155;
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #475569;
    }
</style>

<script>
    // Fitur buat Generate Password Acak (Biar admin ga pusing mikir)
    function generateRandomPass() {
        const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
        let password = "";
        // Wajibin ada 1 uppercase, 1 lowercase, 1 angka, dan panjang 10
        password += "A"; // Garansi Uppercase
        password += "b"; // Garansi Lowercase
        password += "1"; // Garansi Angka
        password += "!"; // Garansi Simbol
        
        for (let i = 0; i < 6; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        
        // Acak urutannya biar gak ketebak
        password = password.split('').sort(function(){return 0.5-Math.random()}).join('');
        
        document.getElementById("forcePassword").value = password;
        
        // Notif tipis kalau udah di-generate
        const btn = document.querySelector('button[title="Generate Random Password"]');
        btn.innerHTML = '<i class="fa-solid fa-check text-emerald-400 text-lg"></i>';
        setTimeout(() => {
            btn.innerHTML = '<i class="fa-solid fa-dice text-lg"></i>';
        }, 1000);
    }
</script>
{% endblock %}
