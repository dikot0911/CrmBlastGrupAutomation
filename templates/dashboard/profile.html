{% extends "dashboard/base.html" %}
{% block title %}Profil Saya{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto pb-24 animate-fade-in profile-shell">
    <section class="profile-hero rounded-3xl p-6 md:p-8 mb-6 md:mb-8">
        <div class="flex flex-col lg:flex-row gap-6 lg:items-end">
            <div class="flex items-center gap-4 md:gap-6">
                <div class="relative group/avatar shrink-0">
                    <button type="button" aria-label="Ubah foto profil" onclick="document.getElementById('avatarUpload').click()" class="w-24 h-24 md:w-28 md:h-28 rounded-full p-[3px] bg-gradient-to-br from-indigo-400 to-purple-500 shadow-lg">
                        <span class="w-full h-full rounded-full overflow-hidden flex items-center justify-center profile-avatar-ring relative">
                            {% if user.avatar_url %}
                                <img id="avatarPreview" src="{{ user.avatar_url }}" alt="Avatar pengguna" class="w-full h-full object-cover">
                            {% else %}
                                <span id="avatarText" class="text-3xl font-bold text-slate-300 select-none">{{ user.email[0]|upper }}</span>
                                <img id="avatarPreview" alt="Avatar pengguna" class="hidden w-full h-full object-cover">
                            {% endif %}
                            <span class="absolute inset-0 opacity-0 group-hover/avatar:opacity-100 transition bg-slate-900/55 flex items-center justify-center text-white text-sm">
                                <i class="fa-solid fa-camera mr-1"></i>Ubah
                            </span>
                        </span>
                    </button>
                    <input type="file" id="avatarUpload" class="hidden" accept="image/*" onchange="previewAvatar(event)">
                    <span class="absolute -bottom-1 -right-1 w-7 h-7 rounded-full grid place-items-center border profile-status-dot">
                        {% if not user.is_banned %}
                            <i class="fa-solid fa-circle-check text-emerald-400"></i>
                        {% else %}
                            <i class="fa-solid fa-ban text-rose-400"></i>
                        {% endif %}
                    </span>
                </div>

                <div>
                    <p class="text-xs uppercase tracking-[0.2em] profile-hero-muted mb-1">Akun aktif</p>
                    <h1 class="text-2xl md:text-3xl font-extrabold text-white tracking-tight">{{ user.email.split('@')[0]|title }}</h1>
                    <div class="mt-2 flex flex-wrap gap-2 text-xs items-center">
                        <span class="profile-pill">ID #{{ '%06d' % user.id }}</span>
                        {% if user.plan_tier == 'UMKM PRO' %}
                            <span class="profile-pill profile-pill-pro">UMKM PRO</span>
                        {% elif user.plan_tier == 'Agency' %}
                            <span class="profile-pill profile-pill-agency">AGENCY</span>
                        {% else %}
                            <span class="profile-pill">STARTER</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="grid sm:grid-cols-2 gap-3 w-full lg:w-auto lg:min-w-[24rem] lg:ml-auto">
                <article class="profile-stat-card">
                    <p class="profile-stat-label">Saldo affiliate</p>
                    <p class="profile-stat-value">Rp {{ "{:,.0f}".format(user.wallet_balance).replace(',', '.') }}</p>
                </article>
                <article class="profile-stat-card">
                    <p class="profile-stat-label">Status akun</p>
                    <p class="profile-stat-value text-base md:text-lg">{{ 'Terverifikasi' if not user.is_banned else 'Dibatasi' }}</p>
                </article>
            </div>
        </div>
    </section>

    <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
        <aside class="xl:col-span-4 space-y-4">
            <section class="profile-card p-5">
                <h2 class="text-sm font-bold mb-3 profile-title"><i class="fa-brands fa-telegram mr-2 text-sky-500"></i>Notifikasi Bot</h2>
                {% if is_notif_connected %}
                    <div class="profile-alert-ok p-3 rounded-xl mb-3 flex items-start gap-3">
                        <i class="fa-solid fa-bell text-emerald-400 mt-0.5"></i>
                        <div>
                            <p class="font-semibold text-sm">Terhubung dan aktif</p>
                            <p class="text-xs opacity-80">Bot akan kirim pengingat sebelum jadwal broadcast dimulai.</p>
                        </div>
                    </div>
                    <a href="https://t.me/{{ bot_username }}" target="_blank" class="profile-btn-secondary w-full text-center">Buka bot Telegram</a>
                {% else %}
                    <p class="text-sm profile-text-muted mb-3">Supaya tidak ketinggalan jadwal, hubungkan Telegram sekarang. Notifikasi dikirim otomatis 5 menit sebelum broadcast.</p>
                    <a href="{{ bot_link }}" target="_blank" class="profile-btn-primary w-full text-center">Hubungkan Telegram</a>
                {% endif %}
            </section>

            <section class="profile-card p-5">
                <h2 class="text-sm font-bold mb-2 profile-title"><i class="fa-solid fa-lightbulb mr-2 text-amber-500"></i>Tips cepat</h2>
                <ul class="text-sm profile-text-muted space-y-2 list-disc list-inside">
                    <li>Lengkapi profil agar tim support lebih cepat bantu saat ada kendala.</li>
                    <li>Periksa paket langganan secara berkala untuk hindari layanan berhenti.</li>
                    <li>Gunakan referral untuk menambah komisi otomatis.</li>
                </ul>
            </section>
        </aside>

        <section class="xl:col-span-8 profile-card p-4 md:p-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-6">
                <button class="tab-btn tab-active" onclick="openTab(event, 'profile')">
                    <span class="icon-box"><i class="fa-solid fa-user"></i></span>
                    Profil
                </button>
                <button class="tab-btn" onclick="openTab(event, 'referral')">
                    <span class="icon-box"><i class="fa-solid fa-link"></i></span>
                    Referral
                </button>
                <button class="tab-btn" onclick="openTab(event, 'subscription')">
                    <span class="icon-box"><i class="fa-solid fa-crown"></i></span>
                    Langganan
                </button>
                <button class="tab-btn" onclick="openTab(event, 'security')">
                    <span class="icon-box"><i class="fa-solid fa-shield-halved"></i></span>
                    Keamanan
                </button>
            </div>

            <div id="content-profile" class="tab-content space-y-5">
                <div class="flex items-start justify-between gap-3 flex-wrap">
                    <div>
                        <h3 class="text-lg font-bold profile-title">Informasi dasar</h3>
                        <p class="text-sm profile-text-muted">Data ini membantu kami menampilkan identitas akun Anda dengan rapi di dashboard.</p>
                    </div>
                    <button type="button" onclick="toggleEdit()" class="profile-btn-secondary"><i class="fa-solid fa-pen mr-2"></i>Edit data</button>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                    <label class="space-y-1">
                        <span class="profile-label">Nama tampilan</span>
                        <input class="profile-input" type="text" value="{{ user.email.split('@')[0]|title }}" disabled>
                    </label>
                    <label class="space-y-1">
                        <span class="profile-label">Email</span>
                        <input class="profile-input" type="email" value="{{ user.email }}" disabled>
                    </label>
                    <label class="space-y-1 md:col-span-2">
                        <span class="profile-label">Nomor WhatsApp</span>
                        <input class="profile-input" type="text" value="{{ user.phone_number or '' }}" placeholder="Contoh: 628123456789" disabled>
                    </label>
                </div>

                <div id="saveBtnContainer" class="hidden pt-2">
                    <button class="profile-btn-primary" onclick="saveProfile(event)">Simpan perubahan</button>
                </div>
            </div>

            <div id="content-referral" class="tab-content hidden space-y-4">
                <h3 class="text-lg font-bold profile-title">Program referral</h3>
                <p class="text-sm profile-text-muted">Bagikan link ini ke teman Anda. Setiap pendaftaran dari link referral akan tercatat otomatis.</p>

                <div class="grid md:grid-cols-2 gap-4">
                    <article class="profile-muted-box p-4">
                        <p class="profile-label mb-1">Link referral Anda</p>
                        <p id="refLink" class="text-sm break-all font-mono profile-title">{{ request.host_url }}register?ref={{ user.referral_code or user.id }}</p>
                        <button class="profile-btn-secondary mt-3" onclick="copyRef()"><i class="fa-regular fa-copy mr-2"></i>Salin link</button>
                    </article>
                    <article class="profile-muted-box p-4">
                        <p class="profile-label mb-1">Dompet komisi</p>
                        <p class="text-2xl font-extrabold profile-title">Rp {{ "{:,.0f}".format(user.wallet_balance).replace(',', '.') }}</p>
                        <button class="profile-btn-secondary mt-3">Request withdraw</button>
                    </article>
                </div>
            </div>

            <div id="content-subscription" class="tab-content hidden space-y-4">
                <div class="flex items-start justify-between gap-3 flex-wrap">
                    <div>
                        <h3 class="text-lg font-bold profile-title">Status langganan</h3>
                        <p class="text-sm profile-text-muted">Pantau masa aktif paket agar automasi bisnis tetap berjalan lancar.</p>
                    </div>
                    <a href="/dashboard/payment" class="profile-btn-primary">Upgrade paket</a>
                </div>

                <article class="profile-muted-box p-5">
                    <div class="flex items-start justify-between gap-3">
                        <div>
                            <p class="profile-label">Paket saat ini</p>
                            <p class="text-2xl font-extrabold profile-title">{{ user.plan_tier|upper }}</p>
                        </div>
                        {% if user.plan_tier == 'Starter' %}
                            <span class="profile-pill">FREE TIER</span>
                        {% else %}
                            <span class="profile-pill profile-pill-pro">ACTIVE</span>
                        {% endif %}
                    </div>
                    {% if user.plan_tier != 'Starter' %}
                        <div class="mt-4">
                            <div class="flex justify-between text-xs mb-1 profile-text-muted">
                                <span>Sisa masa aktif</span>
                                <span class="font-bold">{{ user.days_remaining }} hari</span>
                            </div>
                            <div class="w-full h-2 rounded-full bg-slate-200/70 dark:bg-slate-700/70 overflow-hidden">
                                <div class="h-full w-1/4 bg-indigo-500 rounded-full"></div>
                            </div>
                        </div>
                    {% endif %}
                </article>
            </div>

            <div id="content-security" class="tab-content hidden space-y-4">
                <h3 class="text-lg font-bold profile-title">Keamanan akun</h3>
                <div class="profile-muted-box p-4 flex items-start justify-between gap-3">
                    <div>
                        <p class="font-semibold profile-title">Ganti password</p>
                        <p class="text-sm profile-text-muted">Demi keamanan, sebaiknya perbarui password secara berkala.</p>
                    </div>
                    <button class="profile-btn-secondary">Update</button>
                </div>

                <div class="rounded-xl border border-rose-200/70 bg-rose-50/70 p-4 dark:border-rose-400/30 dark:bg-rose-500/10">
                    <p class="font-semibold text-rose-700 dark:text-rose-300 mb-1"><i class="fa-solid fa-triangle-exclamation mr-2"></i>Zona bahaya</p>
                    <p class="text-sm text-rose-600 dark:text-rose-200 mb-3">Hapus akun bersifat permanen. Semua data tidak bisa dikembalikan.</p>
                    <button onclick="confirmDelete()" class="profile-btn-danger">Hapus akun saya</button>
                </div>
            </div>
        </section>
    </div>
</div>

<div id="deleteModal" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-50 hidden items-center justify-center px-4">
    <div class="profile-card w-full max-w-sm p-5">
        <h3 class="text-lg font-bold profile-title mb-1">Konfirmasi hapus akun</h3>
        <p class="text-sm profile-text-muted mb-4">Masukkan password untuk melanjutkan penghapusan akun permanen.</p>
        <input type="password" id="deletePass" placeholder="Password Anda" class="profile-input mb-4">
        <div class="flex gap-2">
            <button onclick="closeDeleteModal()" class="profile-btn-secondary flex-1">Batal</button>
            <button onclick="alert('Permintaan dikirim ke admin.'); closeDeleteModal();" class="profile-btn-danger flex-1">Hapus</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function openTab(evt, tabName) {
        document.querySelectorAll('.tab-content').forEach((content) => content.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach((tab) => {
            tab.classList.remove('tab-active');
        });

        document.getElementById('content-' + tabName).classList.remove('hidden');
        evt.currentTarget.classList.add('tab-active');
    }

    function copyRef() {
        const text = document.getElementById('refLink').innerText;
        navigator.clipboard.writeText(text).then(() => {
            alert('Link referral berhasil disalin.');
        });
    }

    function toggleEdit() {
        const inputs = document.querySelectorAll('.profile-input');
        const saveContainer = document.getElementById('saveBtnContainer');
        const isDisabled = inputs[0].disabled;

        inputs.forEach((input) => {
            if (input.id !== 'deletePass') {
                input.disabled = !isDisabled;
            }
        });

        saveContainer.classList.toggle('hidden', !isDisabled);
    }

    function saveProfile(event) {
        const btn = event.currentTarget;
        const original = btn.innerText;
        btn.innerText = 'Menyimpan...';
        setTimeout(() => {
            alert('Data profil berhasil disimpan.');
            toggleEdit();
            btn.innerText = original;
        }, 1000);
    }

    function confirmDelete() {
        const modal = document.getElementById('deleteModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeDeleteModal() {
        const modal = document.getElementById('deleteModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    function previewAvatar(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('avatarPreview').src = e.target.result;
                document.getElementById('avatarPreview').classList.remove('hidden');
                const avatarText = document.getElementById('avatarText');
                if (avatarText) avatarText.classList.add('hidden');
            }
            reader.readAsDataURL(file);
        }
    }
</script>

<style>
    .profile-shell { color: var(--text-primary); }
    .profile-hero {
        position: relative;
        overflow: hidden;
        background: linear-gradient(120deg, #1e1b4b 0%, #312e81 45%, #0f172a 100%);
        border: 1px solid rgba(148, 163, 184, 0.25);
    }
    .profile-hero::after {
        content: "";
        position: absolute;
        inset: 0;
        background-image: radial-gradient(circle at 90% 10%, rgba(99,102,241,0.3), transparent 30%);
        pointer-events: none;
    }
    .profile-avatar-ring { background: rgba(15, 23, 42, 0.88); border: 2px solid rgba(148, 163, 184, 0.45); }
    .profile-status-dot { background: #0f172a; border-color: rgba(148, 163, 184, 0.4); }
    .profile-hero-muted { color: #cbd5e1; }

    .profile-card {
        background: var(--panel-bg);
        border: 1px solid var(--border-color);
        border-radius: 1rem;
        box-shadow: 0 8px 30px -20px rgba(37, 99, 235, 0.35);
    }
    .profile-muted-box {
        background: var(--panel-muted);
        border: 1px solid var(--border-color);
        border-radius: .9rem;
    }
    .profile-title { color: var(--text-primary); }
    .profile-text-muted { color: var(--text-muted); }
    .profile-label { font-size: .78rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: .04em; }

    .profile-input {
        width: 100%;
        border-radius: .75rem;
        border: 1px solid var(--border-color);
        background: var(--panel-muted);
        color: var(--text-primary);
        padding: .7rem .85rem;
        font-size: .9rem;
        outline: none;
    }
    .profile-input:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
    .profile-input:disabled { opacity: .8; cursor: not-allowed; }

    .profile-btn-primary,
    .profile-btn-secondary,
    .profile-btn-danger {
        border-radius: .75rem;
        padding: .6rem .95rem;
        font-size: .85rem;
        font-weight: 700;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        transition: all .2s ease;
    }
    .profile-btn-primary { background: #4f46e5; color: #fff; }
    .profile-btn-primary:hover { background: #4338ca; }
    .profile-btn-secondary { background: var(--panel-muted); border: 1px solid var(--border-color); color: var(--text-primary); }
    .profile-btn-secondary:hover { border-color: #6366f1; color: #4f46e5; }
    .profile-btn-danger { background: #e11d48; color: #fff; }
    .profile-btn-danger:hover { background: #be123c; }

    .profile-pill {
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(15, 23, 42, 0.2);
        color: #e2e8f0;
        font-size: .7rem;
        font-weight: 700;
        padding: .25rem .55rem;
        letter-spacing: .03em;
    }
    .profile-pill-pro { border-color: rgba(99, 102, 241, 0.7); background: rgba(99, 102, 241, 0.25); color: #c7d2fe; }
    .profile-pill-agency { border-color: rgba(168, 85, 247, 0.7); background: rgba(168, 85, 247, 0.24); color: #e9d5ff; }

    .profile-stat-card {
        background: rgba(15, 23, 42, 0.35);
        border: 1px solid rgba(203, 213, 225, 0.25);
        border-radius: .8rem;
        padding: .75rem;
    }
    .profile-stat-label { font-size: .7rem; text-transform: uppercase; letter-spacing: .08em; color: #cbd5e1; }
    .profile-stat-value { font-size: 1.1rem; font-weight: 800; color: #fff; }

    .tab-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: .45rem;
        border-radius: .8rem;
        border: 1px solid var(--border-color);
        background: var(--panel-muted);
        color: var(--text-muted);
        font-size: .8rem;
        font-weight: 700;
        min-height: 2.6rem;
        transition: all .2s ease;
    }
    .icon-box {
        width: 1.5rem;
        height: 1.5rem;
        display: inline-grid;
        place-items: center;
        border-radius: .5rem;
        background: rgba(148, 163, 184, 0.18);
        font-size: .75rem;
    }
    .tab-btn:hover { border-color: #818cf8; color: var(--text-primary); }
    .tab-active { background: rgba(79, 70, 229, 0.14); border-color: rgba(79, 70, 229, 0.45); color: #4f46e5; }
    html[data-theme='dark'] .tab-active { color: #a5b4fc; }
    .tab-active .icon-box { background: rgba(79, 70, 229, 0.22); color: inherit; }

    .profile-alert-ok { background: rgba(16, 185, 129, 0.12); border: 1px solid rgba(16, 185, 129, 0.28); color: var(--text-primary); }
</style>
{% endblock %}
