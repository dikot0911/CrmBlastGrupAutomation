<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="BlastPro SaaS Dashboard - Automasi Bisnis Anda">
    <meta name="theme-color" content="#4F46E5">
    
    <title>{% block title %}Dashboard{% endblock %} | BlastPro SaaS</title>
    
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/favicon.png') }}">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            500: '#6366f1',
                            600: '#4f46e5', // Warna Utama (Indigo)
                            700: '#4338ca',
                            900: '#312e81',
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(79, 70, 229, 0.3)'
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Reset */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #F8FAFC; /* Slate-50 */
            color: #1E293B; /* Slate-800 */
        }

        /* Scrollbar Customization */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }

        /* Sidebar Navigation Item */
        .nav-item {
            position: relative;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 3px solid transparent;
        }
        .nav-item:hover {
            background-color: #F1F5F9;
            color: #4F46E5;
            padding-left: 1.2rem; /* Efek geser dikit pas hover */
        }
        .nav-item.active {
            background: linear-gradient(to right, #EEF2FF, #FFFFFF);
            color: #4F46E5;
            border-left-color: #4F46E5;
            font-weight: 600;
        }
        .nav-item.active i {
            color: #4F46E5;
            filter: drop-shadow(0 0 2px rgba(79, 70, 229, 0.4));
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast-enter { animation: slideInRight 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* Loader Overlay */
        #page-loader {
            transition: opacity 0.4s ease, visibility 0.4s;
        }
        #page-loader.hidden {
            opacity: 0;
            visibility: hidden;
        }

        /* Utility Classes */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
    </style>
</head>

<body x-data="{ 
    sidebarOpen: false, 
    profileDropdownOpen: false,
    toggleSidebar() { this.sidebarOpen = !this.sidebarOpen }
}" class="flex h-screen overflow-hidden text-slate-800">

    <div id="page-loader" class="fixed inset-0 z-[9999] bg-white flex flex-col items-center justify-center">
        <div class="relative w-16 h-16">
            <div class="absolute inset-0 border-4 border-indigo-100 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin"></div>
        </div>
        <p class="mt-4 text-sm font-semibold text-indigo-600 animate-pulse tracking-widest">BLASTPRO</p>
    </div>

    <div x-show="sidebarOpen" 
         x-transition:enter="transition-opacity ease-linear duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition-opacity ease-linear duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click="sidebarOpen = false"
         class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-40 md:hidden">
    </div>

    <aside :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full'"
           class="fixed inset-y-0 left-0 z-50 w-64 bg-white border-r border-slate-200 shadow-xl transition-transform duration-300 ease-in-out md:relative md:translate-x-0 md:shadow-none flex flex-col">
        
        <div class="h-16 flex items-center gap-3 px-6 border-b border-slate-100 bg-white sticky top-0 z-10">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center text-white shadow-indigo-200 shadow-lg">
                <i class="fa-solid fa-bolt text-sm"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-slate-800 tracking-tight leading-none">BlastPro</h1>
                <span class="text-[10px] text-slate-400 font-medium tracking-wider uppercase">SaaS Automation</span>
            </div>
            <button @click="sidebarOpen = false" class="md:hidden ml-auto text-slate-400 hover:text-slate-600">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 space-y-8 px-0 custom-scrollbar">
            
            <div>
                <a href="{{ url_for('dashboard_overview') }}" 
                   class="nav-item flex items-center gap-3 px-6 py-2.5 text-sm font-medium text-slate-600 mx-2 rounded-lg mb-1 {{ 'active' if active_page == 'home' else '' }}">
                    <i class="fa-solid fa-chart-pie w-5 text-center text-slate-400 transition-colors"></i>
                    <span>Ringkasan</span>
                </a>
            </div>

            <div>
                <div class="px-6 mb-2 flex items-center gap-2">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Automasi</span>
                    <div class="h-px bg-slate-100 flex-1"></div>
                </div>
                <div class="space-y-0.5">
                    <a href="{{ url_for('dashboard_targets') }}" 
                       class="nav-item flex items-center gap-3 px-6 py-2.5 text-sm font-medium text-slate-600 mx-2 rounded-lg {{ 'active' if active_page == 'targets' else '' }}">
                        <i class="fa-solid fa-bullseye w-5 text-center text-slate-400 transition-colors"></i>
                        <span>Target Grup</span>
                    </a>
                    <a href="{{ url_for('dashboard_schedule') }}" 
                       class="nav-item flex items-center gap-3 px-6 py-2.5 text-sm font-medium text-slate-600 mx-2 rounded-lg {{ 'active' if active_page == 'schedule' else '' }}">
                        <i class="fa-solid fa-calendar-check w-5 text-center text-slate-400 transition-colors"></i>
                        <span>Jadwal Share</span>
                    </a>
                    <a href="{{ url_for('dashboard_templates') }}" 
                       class="nav-item flex items-center gap-3 px-6 py-2.5 text-sm font-medium text-slate-600 mx-2 rounded-lg {{ 'active' if active_page == 'templates' else '' }}">
                        <i class="fa-regular fa-file-lines w-5 text-center text-slate-400 transition-colors"></i>
                        <span>Template Pesan</span>
                    </a>
                </div>
            </div>

            <div>
                <div class="px-6 mb-2 flex items-center gap-2">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Database</span>
                    <div class="h-px bg-slate-100 flex-1"></div>
                </div>
                <div class="space-y-0.5">
                    <a href="{{ url_for('dashboard_crm') }}" 
                       class="nav-item flex items-center gap-3 px-6 py-2.5 text-sm font-medium text-slate-600 mx-2 rounded-lg {{ 'active' if active_page == 'crm' else '' }}">
                        <i class="fa-solid fa-address-book w-5 text-center text-slate-400 transition-colors"></i>
                        <span>CRM User</span>
                    </a>
                    <a href="{{ url_for('dashboard_broadcast') }}" 
                       class="nav-item flex items-center gap-3 px-6 py-2.5 text-sm font-medium text-slate-600 mx-2 rounded-lg {{ 'active' if active_page == 'broadcast' else '' }}">
                        <i class="fa-solid fa-paper-plane w-5 text-center text-slate-400 transition-colors"></i>
                        <span>Broadcast User</span>
                    </a>
                    <a href="{{ url_for('dashboard_auto_reply') }}" 
                       class="nav-item flex items-center gap-3 px-6 py-2.5 text-sm font-medium text-slate-600 mx-2 rounded-lg group {{ 'active' if active_page == 'autoreply' else '' }}">
                        <i class="fa-solid fa-robot w-5 text-center text-slate-400 transition-colors"></i>
                        <span class="flex-1">Auto Reply</span>
                        <span class="bg-indigo-100 text-indigo-600 text-[9px] font-bold px-1.5 py-0.5 rounded border border-indigo-200 shadow-sm group-hover:bg-indigo-600 group-hover:text-white transition-colors">PRO</span>
                    </a>
                </div>
            </div>

            <div>
                <div class="px-6 mb-2 flex items-center gap-2">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Pengaturan</span>
                    <div class="h-px bg-slate-100 flex-1"></div>
                </div>
                <div class="space-y-0.5">
                    <a href="{{ url_for('dashboard_profile') }}" 
                       class="nav-item flex items-center gap-3 px-6 py-2.5 text-sm font-medium text-slate-600 mx-2 rounded-lg {{ 'active' if active_page == 'profile' else '' }}">
                        <i class="fa-solid fa-user-gear w-5 text-center text-slate-400 transition-colors"></i>
                        <span>Profil Saya</span>
                    </a>
                    <a href="{{ url_for('dashboard_connection') }}" 
                       class="nav-item flex items-center gap-3 px-6 py-2.5 text-sm font-medium text-slate-600 mx-2 rounded-lg {{ 'active' if active_page == 'connection' else '' }}">
                        <i class="fa-brands fa-telegram w-5 text-center text-slate-400 transition-colors"></i>
                        <span>Koneksi Telegram</span>
                        {% if user.telegram_account and user.telegram_account.is_active %}
                            <span class="w-2 h-2 bg-emerald-500 rounded-full ml-auto shadow-[0_0_8px_rgba(16,185,129,0.5)] animate-pulse"></span>
                        {% else %}
                            <span class="w-2 h-2 bg-red-400 rounded-full ml-auto"></span>
                        {% endif %}
                    </a>
                    <a href="{{ url_for('dashboard_payment') }}" 
                       class="nav-item flex items-center gap-3 px-6 py-2.5 text-sm font-medium text-slate-600 mx-2 rounded-lg {{ 'active' if active_page == 'payment' else '' }}">
                        <i class="fa-solid fa-credit-card w-5 text-center text-slate-400 transition-colors"></i>
                        <span>Billing & Paket</span>
                    </a>
                </div>
            </div>

        </nav>

        <div class="p-4 border-t border-slate-100 bg-slate-50">
            <div class="flex items-center gap-3 bg-white p-2.5 rounded-xl border border-slate-100 shadow-sm">
                <div class="w-9 h-9 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white flex items-center justify-center font-bold text-sm shadow-md">
                    {{ user.email[0]|upper }}
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-xs font-bold text-slate-700 truncate">{{ user.email.split('@')[0] }}</p>
                    <p class="text-[10px] text-slate-400 truncate">{{ user.plan_tier }} Plan</p>
                </div>
                <a href="{{ url_for('logout') }}" class="text-slate-400 hover:text-red-500 p-1.5 rounded-lg hover:bg-red-50 transition-colors" title="Logout">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </a>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden bg-[#F8FAFC] relative">
        
        <header class="h-16 bg-white/80 backdrop-blur-md border-b border-slate-200 flex items-center justify-between px-4 md:px-8 z-30 sticky top-0">
            
            <div class="flex items-center gap-4">
                <button @click="toggleSidebar()" class="md:hidden p-2 text-slate-500 hover:text-indigo-600 rounded-lg hover:bg-indigo-50 transition-colors">
                    <i class="fa-solid fa-bars-staggered text-lg"></i>
                </button>
                
                <div class="hidden md:flex items-center text-sm text-slate-500">
                    <span class="hover:text-indigo-600 transition-colors cursor-default">Dashboard</span>
                    <i class="fa-solid fa-chevron-right text-[10px] mx-2 text-slate-300"></i>
                    <span class="font-semibold text-slate-800 capitalize">{{ active_page|replace('_', ' ') }}</span>
                </div>
            </div>

            <div class="flex items-center gap-3 md:gap-6">
                
                <div class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-full border border-slate-200">
                    <i class="fa-regular fa-clock text-slate-400 text-xs"></i>
                    <span id="clock-widget" class="text-xs font-mono font-medium text-slate-600">--:--</span>
                </div>

                <div class="relative cursor-pointer group">
                    <i class="fa-regular fa-bell text-slate-500 text-lg group-hover:text-indigo-600 transition-colors"></i>
                    <span class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full border-2 border-white"></span>
                </div>

                <div class="relative" x-data="{ open: false }">
                    <button @click="open = !open" @click.outside="open = false" class="flex items-center gap-2 focus:outline-none">
                        <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold border-2 border-white shadow-sm hover:border-indigo-200 transition-colors">
                            {{ user.email[0]|upper }}
                        </div>
                        <i class="fa-solid fa-chevron-down text-[10px] text-slate-400 md:block hidden"></i>
                    </button>

                    <div x-show="open" 
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="transform opacity-0 scale-95"
                         x-transition:enter-end="transform opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="transform opacity-100 scale-100"
                         x-transition:leave-end="transform opacity-0 scale-95"
                         class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-xl border border-slate-100 py-1 z-50 origin-top-right"
                         style="display: none;">
                        
                        <div class="px-4 py-3 border-b border-slate-50">
                            <p class="text-xs text-slate-500">Login sebagai</p>
                            <p class="text-sm font-bold text-slate-800 truncate">{{ user.email }}</p>
                        </div>
                        
                        <a href="{{ url_for('dashboard_profile') }}" class="block px-4 py-2 text-sm text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 transition-colors">
                            <i class="fa-solid fa-user-gear w-5"></i> Pengaturan Akun
                        </a>
                        <a href="{{ url_for('dashboard_payment') }}" class="block px-4 py-2 text-sm text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 transition-colors">
                            <i class="fa-solid fa-credit-card w-5"></i> Billing
                        </a>
                        <div class="border-t border-slate-50 my-1"></div>
                        <a href="{{ url_for('logout') }}" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors font-medium">
                            <i class="fa-solid fa-arrow-right-from-bracket w-5"></i> Keluar
                        </a>
                    </div>
                </div>

            </div>
        </header>

        <div class="fixed top-20 right-5 z-50 flex flex-col gap-3 pointer-events-none">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div x-data="{ show: true }" x-show="show" x-init="setTimeout(() => show = false, 5000)"
                             class="pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-xl shadow-lg border toast-enter backdrop-blur-sm
                             {{ 'bg-red-50 border-red-200 text-red-700' if category == 'danger' else 'bg-emerald-50 border-emerald-200 text-emerald-700' }}">
                            
                            <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 
                                {{ 'bg-red-100 text-red-600' if category == 'danger' else 'bg-emerald-100 text-emerald-600' }}">
                                <i class="fa-solid {{ 'fa-xmark' if category == 'danger' else 'fa-check' }}"></i>
                            </div>
                            
                            <div class="text-sm font-medium pr-2">
                                {{ message }}
                            </div>

                            <button @click="show = false" class="text-slate-400 hover:text-slate-600 ml-auto">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth" id="page-content">
            <div class="max-w-7xl mx-auto animate-fade-in pb-10">
                {% block content %}{% endblock %}
            </div>

            <footer class="mt-auto py-6 text-center text-slate-400 text-[10px] uppercase tracking-widest font-medium">
                &copy; 2026 BlastPro SaaS. All rights reserved.
            </footer>
        </div>

    </main>

    <script>
        // 1. Loader Logic
        window.addEventListener('load', () => {
            const loader = document.getElementById('page-loader');
            if(loader) {
                setTimeout(() => {
                    loader.classList.add('hidden');
                }, 500); // Delay dikit biar smooth
            }
        });

        // 2. Real-time Clock
        setInterval(() => {
            const el = document.getElementById('clock-widget');
            if(el) {
                const now = new Date();
                el.innerText = now.toLocaleTimeString('id-ID', { 
                    hour: '2-digit', minute: '2-digit', 
                    timeZone: 'Asia/Jakarta' 
                }) + ' WIB';
            }
        }, 1000);

        // 3. Helper API Fetcher (Global)
        async function apiRequest(url, method = 'POST', body = null) {
            try {
                const opts = { 
                    method: method, 
                    headers: {'Content-Type': 'application/json'} 
                };
                if (body) opts.body = JSON.stringify(body);
                
                const res = await fetch(url, opts);
                return await res.json();
            } catch (e) {
                console.error("API Error:", e);
                return { status: 'error', message: 'Gagal terhubung ke server.' };
            }
        }
    </script>

    {% block scripts %}{% endblock %}

    {% if is_demo_mode %}
    <style>
        /* Matikan tombol fungsional biar ga error di demo */
        a[href="/logout"], .badge-admin, button#btn-scan, button#btn-import, button[type="submit"] { 
            pointer-events: none; opacity: 0.6; filter: grayscale(1); cursor: not-allowed;
        }
        
        /* Overlay Cantik */
        body::after {
            content: "LIVE DEMO PREVIEW";
            position: fixed;
            bottom: 20px; right: 20px;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            color: white;
            padding: 8px 16px;
            font-size: 11px;
            font-weight: 800;
            border-radius: 99px;
            z-index: 9999;
            pointer-events: none;
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3);
            letter-spacing: 0.05em;
            animation: bounce-slow 3s infinite;
        }
        @keyframes bounce-slow { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-5px);} }

        /* Animasi Transisi Halaman Demo */
        #page-content {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            opacity: 1; transform: translateY(0);
        }
        #page-content.fading-out {
            opacity: 0; transform: translateY(10px);
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("ðŸš€ DEMO MODE: INTERACTIVE STARTED");

            const tourPages = ['dashboard', 'targets', 'schedule', 'crm', 'broadcast', 'connection'];
            let autoTourTimer = null; 

            // 1. Fungsi Pindah Halaman Tanpa Reload
            async function softTransition(targetPageName) {
                const url = `/live-demo/${targetPageName}`;
                const contentContainer = document.getElementById('page-content');

                // Efek Keluar
                contentContainer.classList.add('fading-out');
                await new Promise(r => setTimeout(r, 300));

                try {
                    const res = await fetch(url);
                    const text = await res.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(text, 'text/html');
                    const newContent = doc.getElementById('page-content').innerHTML;
                    
                    contentContainer.innerHTML = newContent;
                    window.history.pushState({}, '', url);
                    
                    // Update Warna Sidebar (Manual Class Manipulation for Demo)
                    document.querySelectorAll('.nav-item').forEach(el => {
                        el.classList.remove('active');
                        const href = el.getAttribute('href');
                        if(href && href.includes(targetPageName)) {
                            el.classList.add('active');
                        }
                    });

                } catch (err) {
                    console.error("Gagal load demo page", err);
                }

                // Efek Masuk
                contentContainer.classList.remove('fading-out');
            }

            // 2. Logic Auto Tour (Pindah otomatis kalau didiemin)
            function startAutoTour() {
                if (autoTourTimer) clearTimeout(autoTourTimer);

                autoTourTimer = setTimeout(() => {
                    const currentPath = window.location.pathname.split('/').pop();
                    let currentIndex = tourPages.indexOf(currentPath);
                    if (currentIndex === -1) currentIndex = 0;
                    
                    const nextIndex = (currentIndex + 1) % tourPages.length;
                    const nextPage = tourPages[nextIndex];
                    
                    console.log(`Auto Touring to: ${nextPage}`);
                    softTransition(nextPage);
                    startAutoTour(); // Loop lagi
                }, 10000); // 10 Detik
            }

            // 3. Logic Klik Manual (User Klik Sidebar)
            document.body.addEventListener('click', (e) => {
                const link = e.target.closest('a');
                if (!link) return;

                const href = link.getAttribute('href');
                if (!href) return;

                // Cegah link berbahaya
                if (href === '/logout' || href.includes('profile')) {
                    e.preventDefault();
                    return;
                }

                // Kalau user klik link dashboard
                if (href.startsWith('/dashboard/')) {
                    e.preventDefault(); // Jangan reload
                    const pageName = href.split('/').pop();
                    
                    softTransition(pageName); // Pindah halus
                    startAutoTour(); // Reset timer auto tour
                }
                else if (href === '/dashboard') {
                    e.preventDefault();
                    softTransition('dashboard');
                    startAutoTour();
                }
            });

            // Mulai Auto Tour Pertama Kali
            startAutoTour();
        });
    </script>
    {% endif %}

</body>
</html>
