<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Dashboard{% endblock %} - BlastPro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; }
        
        /* Sidebar Styling */
        .nav-item { transition: all 0.2s ease-in-out; border-right: 3px solid transparent; }
        .nav-item:hover { background-color: #F9FAFB; color: #4F46E5; cursor: pointer; }
        .nav-item.active { background-color: #EEF2FF; color: #4F46E5; border-right-color: #4F46E5; font-weight: 600; }

        /* Animations & Scrollbar */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }
        .pulse-green { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }
    </style>
</head>
<body class="flex h-screen overflow-hidden bg-gray-50">

    <aside class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col z-20 shadow-sm">
        <div class="p-6 border-b border-gray-100 flex items-center gap-3">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white shadow-indigo-200 shadow-lg">
                <i class="fa-solid fa-bolt"></i>
            </div>
            <span class="font-bold text-xl text-gray-800 tracking-tight">BlastPro</span>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 space-y-1">
            <a href="/dashboard" class="nav-item flex items-center gap-3 px-6 py-3 text-sm font-medium text-gray-600 {% if active_page == 'dashboard' %}active{% endif %}">
                <i class="fa-solid fa-chart-pie w-5 text-center"></i> Ringkasan
            </a>
            
            <div class="px-6 pt-4 pb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Automasi</div>
            
            <a href="/dashboard/targets" class="nav-item flex items-center gap-3 px-6 py-3 text-sm font-medium text-gray-600 {% if active_page == 'targets' %}active{% endif %}">
                <i class="fa-solid fa-bullseye w-5 text-center"></i> Target Grup
            </a>
            <a href="/dashboard/schedule" class="nav-item flex items-center gap-3 px-6 py-3 text-sm font-medium text-gray-600 {% if active_page == 'schedule' %}active{% endif %}">
                <i class="fa-solid fa-calendar-clock w-5 text-center"></i> Jadwal Blast
            </a>
            <a href="/dashboard/templates" class="nav-item flex items-center gap-3 px-6 py-3 text-sm font-medium text-gray-600 {% if active_page == 'templates' %}active{% endif %}">
                <i class="fa-solid fa-file-lines w-5 text-center"></i> Template Pesan
            </a>

            <div class="px-6 pt-4 pb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Database</div>
            
            <a href="/dashboard/crm" class="nav-item flex items-center gap-3 px-6 py-3 text-sm font-medium text-gray-600 {% if active_page == 'crm' %}active{% endif %}">
                <i class="fa-solid fa-address-book w-5 text-center"></i> CRM User
            </a>
            <a href="/dashboard/broadcast" class="nav-item flex items-center gap-3 px-6 py-3 text-sm font-medium text-gray-600 {% if active_page == 'broadcast' %}active{% endif %}">
                <i class="fa-solid fa-paper-plane w-5 text-center"></i> Broadcast
            </a>

            <div class="px-6 pt-4 pb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Pengaturan</div>
            <a href="/dashboard/profile" class="nav-item flex items-center gap-3 px-6 py-3 text-sm font-medium text-gray-600 {% if active_page == 'profile' %}active{% endif %}">
                <i class="fa-solid fa-user-gear w-5 text-center"></i> Profil Saya
            </a>
            <a href="/dashboard/connection" class="nav-item flex items-center gap-3 px-6 py-3 text-sm font-medium text-gray-600 {% if active_page == 'connection' %}active{% endif %}">
                <i class="fa-brands fa-telegram w-5 text-center"></i> Koneksi Telegram
                {% if user.telegram_account and user.telegram_account.is_active %}
                <span class="w-2 h-2 bg-green-500 rounded-full ml-auto animate-pulse" title="Connected"></span>
                {% else %}
                <span class="w-2 h-2 bg-red-500 rounded-full ml-auto" title="Offline"></span>
                {% endif %}
            </a>
        </nav>

        <div class="p-4 border-t border-gray-100 bg-gray-50">
            <div class="flex items-center justify-between gap-2">
                <a href="/dashboard/profile" class="flex items-center gap-3 flex-1 hover:bg-white p-2 rounded-lg transition-colors group overflow-hidden">
                    <div class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-lg group-hover:scale-105 transition-transform flex-shrink-0">
                        {{ user.email[0]|upper }}
                    </div>
                    <div class="overflow-hidden flex-1 min-w-0">
                        <p class="text-sm font-bold text-gray-700 truncate group-hover:text-indigo-600 transition-colors" title="{{ user.email }}">{{ user.email }}</p>
                        <div class="flex items-center gap-2 mt-0.5">
                            <span class="w-2 h-2 rounded-full flex-shrink-0 {{ 'bg-green-500 pulse-green' if user.telegram_account and user.telegram_account.is_active else 'bg-red-400' }}"></span>
                            <span class="text-xs text-gray-500 truncate">{{ 'Online' if user.telegram_account and user.telegram_account.is_active else 'Offline' }}</span>
                        </div>
                    </div>
                </a>
                <a href="/logout" class="text-gray-400 hover:text-red-500 transition p-2 rounded-lg hover:bg-red-50 flex-shrink-0" title="Keluar">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </a>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative" id="main-wrapper">
        <header class="bg-white border-b border-gray-200 p-4 md:hidden flex justify-between items-center z-30">
            <span class="font-bold text-lg text-indigo-600">BlastPro</span>
            <button class="text-gray-600 hover:text-indigo-600" onclick="alert('Gunakan Desktop Mode untuk pengalaman terbaik.')"><i class="fa-solid fa-bars fa-lg"></i></button>
        </header>

        <div class="fixed top-5 right-5 z-50 space-y-2 pointer-events-none">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="px-4 py-3 rounded-xl shadow-lg text-white text-sm font-bold flex items-center animate-enter pointer-events-auto {{ 'bg-red-500' if category == 'danger' else 'bg-green-500' }}">
                            <i class="fa-solid {{ 'fa-circle-exclamation' if category == 'danger' else 'fa-circle-check' }} mr-2"></i>
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <div class="flex-1 overflow-y-auto p-6 md:p-8 scroll-smooth" id="page-content">
            {% block content %}{% endblock %}
        </div>
    </main>

    <script>
        setInterval(() => {
            const el = document.getElementById('clock-widget');
            if(el) {
                const now = new Date();
                el.innerText = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Jakarta' }) + ' WIB';
            }
        }, 1000);

        async function apiRequest(url, method = 'POST', body = null) {
            try {
                const opts = { method: method, headers: {'Content-Type': 'application/json'} };
                if (body) opts.body = JSON.stringify(body);
                const res = await fetch(url, opts);
                return await res.json();
            } catch (e) {
                return { status: 'error', message: 'Koneksi bermasalah.' };
            }
        }
    </script>

    {% block scripts %}{% endblock %}

    {% if is_demo_mode %}
    <style>
        /* Matikan tombol fungsional biar ga error di demo */
        a[href="/logout"], .badge-admin, button#btn-scan, button#btn-import, button[type="submit"] { 
            pointer-events: none; opacity: 0.5; filter: grayscale(1); 
        }
        
        /* Overlay Cantik */
        body::before {
            content: "LIVE DEMO MODE";
            position: fixed;
            bottom: 15px; right: 15px;
            background: rgba(79, 70, 229, 0.9);
            color: white;
            padding: 6px 12px;
            font-size: 10px;
            font-weight: bold;
            border-radius: 20px;
            z-index: 9999;
            pointer-events: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float { 0%,100% {transform: translateY(0);} 50% {transform: translateY(-5px);} }

        /* Animasi Transisi Halaman */
        #page-content {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            opacity: 1; transform: translateY(0);
        }
        #page-content.fading-out {
            opacity: 0; transform: translateY(10px);
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("ðŸš€ DEMO MODE: INTERACTIVE STARTED");

            const tourPages = ['dashboard', 'targets', 'schedule', 'crm', 'broadcast', 'connection'];
            let autoTourTimer = null; 

            // 1. Fungsi Pindah Halaman Tanpa Reload
            async function softTransition(targetPageName) {
                const url = `/live-demo/${targetPageName}`;
                const contentContainer = document.getElementById('page-content');

                // Efek Keluar
                contentContainer.classList.add('fading-out');
                await new Promise(r => setTimeout(r, 300));

                try {
                    const res = await fetch(url);
                    const text = await res.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(text, 'text/html');
                    const newContent = doc.getElementById('page-content').innerHTML;
                    
                    contentContainer.innerHTML = newContent;
                    window.history.pushState({}, '', url);
                    
                    // Update Warna Sidebar
                    document.querySelectorAll('.nav-item').forEach(el => {
                        el.classList.remove('active', 'bg-indigo-50', 'text-indigo-600');
                        const href = el.getAttribute('href');
                        if(href && href.includes(targetPageName)) {
                            el.classList.add('active', 'bg-indigo-50', 'text-indigo-600');
                        }
                    });

                } catch (err) {
                    console.error("Gagal load demo page", err);
                }

                // Efek Masuk
                contentContainer.classList.remove('fading-out');
            }

            // 2. Logic Auto Tour (Pindah otomatis kalau didiemin)
            function startAutoTour() {
                if (autoTourTimer) clearTimeout(autoTourTimer);

                autoTourTimer = setTimeout(() => {
                    const currentPath = window.location.pathname.split('/').pop();
                    let currentIndex = tourPages.indexOf(currentPath);
                    if (currentIndex === -1) currentIndex = 0;
                    
                    const nextIndex = (currentIndex + 1) % tourPages.length;
                    const nextPage = tourPages[nextIndex];
                    
                    console.log(`Auto Touring to: ${nextPage}`);
                    softTransition(nextPage);
                    startAutoTour(); // Loop lagi
                }, 8000); // 8 Detik
            }

            // 3. Logic Klik Manual (User Klik Sidebar)
            document.body.addEventListener('click', (e) => {
                const link = e.target.closest('a');
                if (!link) return;

                const href = link.getAttribute('href');
                if (!href) return;

                // Cegah link berbahaya
                if (href === '/logout' || href.includes('profile')) {
                    e.preventDefault();
                    return;
                }

                // Kalau user klik link dashboard
                if (href.startsWith('/dashboard/')) {
                    e.preventDefault(); // Jangan reload
                    const pageName = href.split('/').pop();
                    
                    softTransition(pageName); // Pindah halus
                    startAutoTour(); // Reset timer auto tour
                }
                else if (href === '/dashboard') {
                    e.preventDefault();
                    softTransition('dashboard');
                    startAutoTour();
                }
            });

            // Mulai Auto Tour Pertama Kali
            startAutoTour();
        });
    </script>
    {% endif %}

</body>
</html>
