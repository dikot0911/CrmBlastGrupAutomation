{% extends "dashboard/base.html" %}
{% block title %}Manager Target Grup{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto animate-fade-in pb-32" x-data="targetManager()">
    
    <div class="flex flex-col lg:flex-row justify-between items-end mb-10 gap-6">
        <div class="flex-1">
            <div class="flex items-center gap-4 mb-3">
                <div class="w-14 h-14 bg-gradient-to-br from-indigo-600 to-violet-600 rounded-2xl flex items-center justify-center text-white shadow-xl shadow-indigo-500/20 transform hover:scale-105 transition-transform duration-300 ring-4 ring-indigo-50">
                    <i class="fa-solid fa-layer-group text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">Koleksi Target</h1>
                    <div class="flex items-center gap-2 text-xs font-medium text-slate-500 mt-1.5">
                        <span class="px-2.5 py-0.5 rounded-md bg-indigo-50 text-indigo-600 border border-indigo-100 flex items-center gap-1.5">
                            <i class="fa-solid fa-server"></i> {{ accounts|length }} Sumber Akun
                        </span>
                        <span class="w-1 h-1 rounded-full bg-slate-300"></span>
                        <span class="flex items-center gap-1.5">
                            <i class="fa-solid fa-folder-tree"></i> Mode Template
                        </span>
                    </div>
                </div>
            </div>
            <p class="text-slate-500 max-w-3xl leading-relaxed text-sm pl-1 border-l-4 border-indigo-100 py-1 ml-1">
                Atur database grup promosi Anda dalam bentuk <b>Template / Koleksi</b>. 
                Satu template bisa berisi ratusan grup dengan konfigurasi topik yang spesifik. Pisahkan target berdasarkan niche (misal: "Grup Kuliner", "Forum Crypto").
            </p>
        </div>
        
        <div class="flex flex-col sm:flex-row items-center gap-3 w-full lg:w-auto bg-white p-2 rounded-2xl shadow-sm border border-slate-100">
            <div class="relative w-full sm:w-64 group">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i class="fa-solid fa-magnifying-glass text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                </div>
                <input type="text" x-model="searchQuery" placeholder="Cari template atau grup..." 
                       class="block w-full pl-11 pr-10 py-3 bg-slate-50 border-0 rounded-xl text-sm font-medium focus:ring-2 focus:ring-indigo-500/20 focus:bg-white transition-all placeholder-slate-400">
                <button x-show="searchQuery" @click="searchQuery = ''" class="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-red-500 transition" x-transition>
                    <i class="fa-solid fa-circle-xmark"></i>
                </button>
            </div>

            <div class="flex gap-2 w-full sm:w-auto border-l border-slate-100 pl-2 sm:pl-3">
                <button onclick="openImportModal()" class="flex-1 sm:flex-none bg-white hover:bg-emerald-50 text-slate-600 hover:text-emerald-600 border border-slate-200 hover:border-emerald-200 px-4 py-3 rounded-xl font-bold shadow-sm transition-all flex items-center justify-center gap-2 group relative overflow-hidden">
                    <div class="absolute inset-0 bg-emerald-100 opacity-0 group-hover:opacity-10 transition-opacity"></div>
                    <i class="fa-solid fa-file-import text-emerald-500 group-hover:scale-110 transition-transform"></i>
                    <span class="text-xs uppercase tracking-wide">Import CSV</span>
                </button>
                
                <button onclick="openScanModal()" class="flex-1 sm:flex-none bg-slate-900 hover:bg-indigo-900 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-slate-900/20 hover:shadow-indigo-900/30 transition-all transform hover:-translate-y-0.5 active:scale-95 flex items-center justify-center gap-2 group">
                    <div class="relative">
                        <i class="fa-solid fa-radar animate-pulse text-indigo-300"></i>
                        <span class="absolute top-0 right-0 -mt-1 -mr-1 flex h-2 w-2">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-indigo-500"></span>
                        </span>
                    </div>
                    <span class="text-xs uppercase tracking-wide">Scan Baru</span>
                </button>
            </div>
        </div>
    </div>

    {% if not grouped_targets %}
        <div class="flex flex-col items-center justify-center py-28 bg-white rounded-[2.5rem] border-2 border-dashed border-slate-200 text-center group cursor-pointer hover:border-indigo-300 hover:bg-indigo-50/10 transition-all duration-500 relative overflow-hidden" onclick="openScanModal()">
            <div class="absolute inset-0 bg-grid-slate-100 [mask-image:linear-gradient(0deg,white,rgba(255,255,255,0.6))] -z-10"></div>
            
            <div class="relative mb-8">
                <div class="absolute inset-0 bg-indigo-100 rounded-full animate-ping opacity-20 group-hover:opacity-40 duration-1000"></div>
                <div class="w-28 h-28 bg-white rounded-full flex items-center justify-center shadow-xl relative z-10 border border-slate-100 group-hover:border-indigo-200 group-hover:scale-110 transition-transform duration-300 group-hover:rotate-3">
                    <i class="fa-solid fa-folder-plus text-5xl text-slate-300 group-hover:text-indigo-500 transition-colors"></i>
                </div>
                <i class="fa-brands fa-telegram absolute -top-2 -right-4 text-2xl text-blue-400 animate-bounce delay-100"></i>
                <i class="fa-solid fa-bullseye absolute bottom-0 -left-6 text-2xl text-red-400 animate-bounce delay-700"></i>
            </div>
            
            <h3 class="text-2xl font-bold text-slate-800 group-hover:text-indigo-700 transition-colors">Database Masih Kosong</h3>
            <p class="text-slate-400 max-w-md mt-3 mb-8 leading-relaxed text-sm">
                Anda belum memiliki template target. Yuk mulai dengan melakukan <b>Scan Otomatis</b> dari Telegram atau <b>Import CSV</b> untuk membuat koleksi pertama Anda.
            </p>
            
            <div class="flex items-center gap-4">
                <button class="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm shadow-xl shadow-indigo-200 hover:bg-indigo-700 transition transform hover:-translate-y-1">
                    <i class="fa-solid fa-magic-wand-sparkles mr-2"></i> Buat Template Pertama
                </button>
            </div>
        </div>
    {% else %}
        
        <div class="space-y-12">
            {% for source_phone, templates in grouped_targets.items() %}
            <div class="account-section animate-enter" x-show="matchAccount('{{ source_phone }}', {{ templates|tojson }})">
                
                <div class="flex items-center gap-4 mb-6 px-4 py-3 sticky top-16 z-20 bg-[#F8FAFC]/95 backdrop-blur-md border-b border-slate-200/60 rounded-xl shadow-sm transition-all duration-300 hover:shadow-md">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-white shadow-lg shadow-blue-500/20 ring-2 ring-white">
                        <i class="fa-brands fa-telegram text-2xl"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            {{ templates.values()|first|first|attr('source_name') if templates else 'Akun Telegram' }}
                            <span class="text-[10px] font-mono font-medium text-slate-500 bg-white px-2 py-0.5 rounded border border-slate-200 shadow-sm">{{ source_phone }}</span>
                        </h2>
                        <div class="flex items-center gap-3 text-xs text-slate-500 mt-0.5">
                            <span class="flex items-center gap-1"><i class="fa-solid fa-folder-open text-blue-400"></i> {{ templates|length }} Template</span>
                            <span class="w-1 h-1 rounded-full bg-slate-300"></span>
                            <span class="text-emerald-600 font-medium flex items-center gap-1"><i class="fa-solid fa-circle-check"></i> Connected</span>
                        </div>
                    </div>
                    <div class="ml-auto hidden sm:flex items-center gap-2 px-3 py-1.5 bg-white rounded-lg border border-slate-100 shadow-sm">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Total Grup</span>
                        <span class="text-sm font-bold text-indigo-600">
                            {% set total_groups = namespace(value=0) %}
                            {% for _, grps in templates.items() %}{% set total_groups.value = total_groups.value + grps|length %}{% endfor %}
                            {{ total_groups.value }}
                        </span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 px-1">
                    {% for tmpl_name, groups in templates.items() %}
                    <div class="template-card bg-white rounded-2xl border border-slate-200 shadow-[0_2px_10px_-4px_rgba(0,0,0,0.05)] hover:shadow-xl hover:shadow-indigo-500/10 transition-all duration-300 flex flex-col h-full group relative overflow-hidden"
                         x-show="matchTemplate('{{ tmpl_name }}')">
                        
                        <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>

                        <div class="p-6 flex-1 flex flex-col">
                            
                            <div class="flex justify-between items-start mb-5">
                                <div class="w-14 h-14 rounded-2xl bg-slate-50 border border-slate-100 flex items-center justify-center text-2xl font-black text-slate-300 group-hover:bg-indigo-50 group-hover:text-indigo-600 group-hover:border-indigo-100 transition-all duration-300 shadow-inner">
                                    {{ tmpl_name[:1]|upper }}
                                </div>
                                <div class="relative" x-data="{ open: false }">
                                    <button @click="open = !open" @click.outside="open = false" class="w-8 h-8 rounded-lg hover:bg-slate-100 text-slate-300 hover:text-slate-600 transition flex items-center justify-center">
                                        <i class="fa-solid fa-ellipsis-vertical"></i>
                                    </button>
                                    <div x-show="open" class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-xl border border-slate-100 py-1.5 z-20 origin-top-right animate-scale-in" style="display: none;">
                                        <div class="px-4 py-2 border-b border-slate-50">
                                            <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Menu Template</p>
                                        </div>
                                        <button onclick="viewDetails('{{ tmpl_name }}', {{ groups|tojson }})" class="w-full text-left px-4 py-2.5 text-xs font-bold text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 transition flex items-center gap-2.5">
                                            <i class="fa-solid fa-eye w-4 text-center"></i> Lihat & Edit Isi
                                        </button>
                                        <button onclick="promptRename('{{ tmpl_name }}', '{{ source_phone }}')" class="w-full text-left px-4 py-2.5 text-xs font-bold text-slate-600 hover:bg-amber-50 hover:text-amber-600 transition flex items-center gap-2.5">
                                            <i class="fa-solid fa-pen-to-square w-4 text-center"></i> Ganti Nama
                                        </button>
                                        <div class="h-px bg-slate-50 my-1"></div>
                                        <button onclick="deleteTemplate('{{ tmpl_name }}', '{{ source_phone }}')" class="w-full text-left px-4 py-2.5 text-xs font-bold text-red-500 hover:bg-red-50 transition flex items-center gap-2.5">
                                            <i class="fa-solid fa-trash-can w-4 text-center"></i> Hapus Template
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h3 class="font-bold text-lg text-slate-800 mb-1.5 group-hover:text-indigo-700 transition-colors line-clamp-1" title="{{ tmpl_name }}">
                                    {{ tmpl_name }}
                                </h3>
                                <div class="flex items-center gap-3 text-xs text-slate-500">
                                    <span class="flex items-center gap-1.5 bg-slate-50 px-2 py-1 rounded-md border border-slate-100 group-hover:border-indigo-100 transition-colors">
                                        <i class="fa-solid fa-layer-group text-slate-400 group-hover:text-indigo-400"></i> 
                                        <b>{{ groups|length }}</b> Grup
                                    </span>
                                    <span class="text-slate-300">|</span>
                                    <span class="text-slate-400 text-[10px]">{{ groups[0].created_at[:10] }}</span>
                                </div>
                            </div>

                            <div class="bg-slate-50/80 rounded-xl p-3 border border-slate-100 mt-auto group-hover:bg-indigo-50/30 group-hover:border-indigo-100 transition-colors">
                                <p class="text-[9px] font-bold text-slate-400 uppercase mb-2 tracking-widest flex justify-between">
                                    <span>Preview Isi</span>
                                    <i class="fa-solid fa-list-ul"></i>
                                </p>
                                <ul class="space-y-1.5">
                                    {% for g in groups[:3] %}
                                    <li class="flex items-center gap-2 text-xs text-slate-600">
                                        <div class="w-1.5 h-1.5 rounded-full bg-indigo-400 flex-shrink-0"></div>
                                        <span class="truncate font-medium">{{ g.group_name }}</span>
                                    </li>
                                    {% endfor %}
                                    {% if groups|length > 3 %}
                                    <li class="text-[10px] text-slate-400 font-bold pl-3.5">+ {{ groups|length - 3 }} grup lainnya...</li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>

                        <div class="absolute inset-0 z-0 cursor-pointer" onclick="viewDetails('{{ tmpl_name }}', {{ groups|tojson }})"></div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="border-b border-dashed border-slate-200 mt-10 mx-4"></div>
            </div>
            {% endfor %}
        </div>
    {% endif %}

</div>

<div id="detailModal" class="fixed inset-0 z-[100] hidden" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity opacity-0" id="detailBackdrop" onclick="closeDetailModal()"></div>
    
    <div class="fixed inset-y-0 right-0 z-10 w-full max-w-2xl bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-out flex flex-col" id="detailPanel">
        
        <div class="px-8 py-6 border-b border-slate-100 bg-white z-20 flex justify-between items-start shadow-sm">
            <div>
                <span class="text-[10px] font-bold text-indigo-500 uppercase tracking-widest bg-indigo-50 px-2 py-1 rounded border border-indigo-100 mb-2 inline-block">Template Detail</span>
                <h3 class="text-2xl font-extrabold text-slate-800" id="detailTitle">Loading...</h3>
                <p class="text-sm text-slate-500 mt-1 flex items-center gap-2">
                    <i class="fa-solid fa-folder-open text-slate-400"></i>
                    <span id="detailSubtitle">0 Grup</span>
                </p>
            </div>
            <button onclick="closeDetailModal()" class="w-10 h-10 rounded-xl bg-slate-50 text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition flex items-center justify-center border border-slate-100">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-8 bg-slate-50/50 custom-scrollbar">
            <div id="detailList" class="space-y-3">
                </div>
        </div>

        <div class="px-8 py-5 border-t border-slate-100 bg-white flex justify-between items-center shrink-0">
            <button onclick="deleteCurrentTemplate()" class="text-red-500 hover:text-red-700 text-xs font-bold flex items-center gap-2 px-4 py-2 hover:bg-red-50 rounded-lg transition">
                <i class="fa-solid fa-trash-can"></i> Hapus Semua
            </button>
            <div class="flex gap-3">
                <button onclick="closeDetailModal()" class="px-6 py-2.5 rounded-xl border border-slate-200 text-slate-600 font-bold text-sm hover:bg-slate-50 transition">
                    Tutup
                </button>
                <button class="px-6 py-2.5 rounded-xl bg-indigo-600 text-white font-bold text-sm hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition flex items-center gap-2 cursor-not-allowed opacity-80" title="Auto-Save Enabled">
                    <i class="fa-solid fa-check"></i> Auto Saved
                </button>
            </div>
        </div>
    </div>
</div>

<div id="scanModal" class="fixed inset-0 z-[100] hidden">
    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity opacity-0" id="scanBackdrop"></div>
    <div class="fixed inset-0 z-10 overflow-hidden flex items-center justify-center p-4">
        <div class="relative transform flex flex-col w-full max-w-3xl h-[85vh] bg-white rounded-[2rem] shadow-2xl transition-all opacity-0 scale-95 border border-slate-200 overflow-hidden ring-1 ring-black/5" id="scanPanel">
            
            <div class="bg-white px-8 py-6 border-b border-slate-100 flex justify-between items-center shrink-0 relative z-20">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-indigo-50 rounded-2xl flex items-center justify-center text-indigo-600 shadow-sm border border-indigo-100">
                        <i class="fa-brands fa-telegram text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                            Scan Grup Baru
                        </h3>
                        <p class="text-xs text-slate-500 mt-0.5">Sinkronisasi grup dari akun Telegram ke dalam template.</p>
                    </div>
                </div>
                <button onclick="closeScanModal()" class="w-10 h-10 rounded-xl bg-slate-50 text-slate-400 hover:bg-red-50 hover:text-red-500 transition flex items-center justify-center border border-slate-100">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>

            <div class="px-8 py-6 bg-slate-50/80 border-b border-slate-200/60 shrink-0 grid grid-cols-1 sm:grid-cols-2 gap-5 backdrop-blur-sm">
                <div>
                    <label class="text-[10px] font-bold text-indigo-900 uppercase tracking-widest mb-2 block flex items-center gap-1.5">
                        <i class="fa-solid fa-circle-user"></i> Akun Sumber
                    </label>
                    <div class="relative">
                        <select id="scanAccountSelect" class="block w-full pl-4 pr-10 py-3 text-sm font-bold text-slate-700 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm cursor-pointer appearance-none transition hover:border-indigo-300">
                            {% for acc in accounts %}
                                <option value="{{ acc.phone_number }}">{{ acc.first_name or 'Akun' }} ({{ acc.phone_number }})</option>
                            {% else %}
                                <option value="" disabled selected>⚠️ Tidak ada akun aktif</option>
                            {% endfor %}
                        </select>
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-slate-400">
                            <i class="fa-solid fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-indigo-900 uppercase tracking-widest mb-2 block flex items-center gap-1.5">
                        <i class="fa-solid fa-tag"></i> Nama Template Baru
                    </label>
                    <input type="text" id="scanTemplateName" placeholder="Contoh: Grup Jualan Pagi" 
                           class="block w-full px-4 py-3 text-sm font-bold text-slate-700 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition placeholder-slate-400 hover:border-indigo-300">
                </div>
            </div>

            <div id="initialState" class="flex-1 flex flex-col items-center justify-center bg-white relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full bg-[radial-gradient(#e0e7ff_1px,transparent_1px)] [background-size:16px_16px] opacity-30"></div>
                
                <div class="relative z-10 text-center">
                    <button onclick="startScanning()" id="btnStartScan" class="bg-slate-900 hover:bg-slate-800 text-white px-10 py-4 rounded-2xl font-bold text-lg shadow-2xl shadow-slate-900/30 transition-all transform hover:-translate-y-1 active:scale-95 flex items-center gap-3 mx-auto group">
                        <i class="fa-solid fa-radar animate-pulse text-indigo-300 group-hover:text-white transition-colors"></i> 
                        <span>Mulai Scanning</span>
                        <i class="fa-solid fa-arrow-right text-sm opacity-50 group-hover:opacity-100 group-hover:translate-x-1 transition-all"></i>
                    </button>
                    <p class="text-slate-400 text-xs mt-4 font-medium bg-white/80 px-3 py-1 rounded-full inline-block border border-slate-100">
                        <i class="fa-solid fa-info-circle mr-1"></i> Pastikan akun Telegram aktif di server.
                    </p>
                </div>
            </div>

            <div id="loadingScan" class="hidden flex-1 flex flex-col items-center justify-center bg-white z-20">
                <div class="relative">
                    <div class="w-16 h-16 border-4 border-indigo-100 rounded-full"></div>
                    <div class="absolute inset-0 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin"></div>
                </div>
                <h4 class="font-bold text-slate-800 mt-6 text-lg animate-pulse">Sedang Memindai...</h4>
                <p class="text-xs text-slate-500">Mohon tunggu, jangan tutup halaman ini.</p>
            </div>

            <div id="resultList" class="hidden flex-1 overflow-y-auto p-8 bg-slate-50 grid gap-3 pb-32"></div>

            <div id="saveBar" class="hidden px-8 py-5 bg-white border-t border-slate-200 flex justify-between items-center shrink-0 shadow-[0_-10px_40px_-10px_rgba(0,0,0,0.05)] z-30">
                <div class="flex items-center gap-3">
                    <span class="flex items-center justify-center w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 font-bold text-xs" id="selectedCountNum">0</span>
                    <span class="text-sm font-bold text-slate-700">Grup Dipilih</span>
                </div>
                <button onclick="saveSelection()" id="btnSave" class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:shadow-indigo-300 transition transform active:scale-95 flex items-center gap-2">
                    <span>Simpan Target</span>
                    <i class="fa-solid fa-check-circle"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div id="importModal" class="fixed inset-0 z-[100] hidden">
    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity opacity-0" onclick="closeImportModal()" id="importBackdrop"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4 pointer-events-none">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-lg p-0 relative transform scale-95 opacity-0 transition-all pointer-events-auto overflow-hidden" id="importPanel">
            
            <div class="bg-slate-900 px-8 py-6 text-white relative overflow-hidden">
                <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white/10 rounded-full blur-2xl"></div>
                <button onclick="closeImportModal()" class="absolute top-4 right-4 text-white/50 hover:text-white transition"><i class="fa-solid fa-xmark text-xl"></i></button>
                <div class="w-14 h-14 bg-white/10 rounded-2xl flex items-center justify-center mb-4 backdrop-blur-sm border border-white/10">
                    <i class="fa-solid fa-file-csv text-3xl text-emerald-400"></i>
                </div>
                <h3 class="text-2xl font-bold">Import Target CSV</h3>
                <p class="text-slate-400 text-sm mt-1">Upload daftar grup massal dari file eksternal.</p>
            </div>

            <div class="p-8">
                <form id="csvForm" onsubmit="submitCsv(event)" class="space-y-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Pilih Akun Sumber</label>
                        <div class="relative">
                            <select name="source_phone" required class="w-full pl-4 pr-10 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none transition font-bold text-slate-700 text-sm appearance-none">
                                {% for acc in accounts %}
                                    <option value="{{ acc.phone_number }}">{{ acc.first_name }} ({{ acc.phone_number }})</option>
                                {% endfor %}
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-4 top-3.5 text-slate-400 text-xs"></i>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Nama Template Baru</label>
                        <input type="text" name="template_name" required placeholder="Contoh: Import Maret 2026" 
                               class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none transition text-sm font-bold placeholder-slate-400">
                    </div>

                    <div class="border-2 border-dashed border-slate-200 rounded-2xl p-8 text-center hover:border-emerald-400 hover:bg-emerald-50/30 transition bg-slate-50 group cursor-pointer relative">
                        <input type="file" name="file" accept=".csv" required class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="document.getElementById('fileNameDisplay').innerText = this.files[0].name; document.getElementById('fileIcon').classList.add('text-emerald-500', 'scale-110');">
                        <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-300 mb-3 group-hover:text-emerald-500 transition-colors transform duration-300" id="fileIcon"></i>
                        <p class="text-sm font-bold text-slate-600 group-hover:text-emerald-700 transition" id="fileNameDisplay">Klik untuk upload file CSV</p>
                        <p class="text-[10px] text-slate-400 mt-1">Format header: <code>group_id, group_name, topic_ids</code></p>
                    </div>

                    <button type="submit" id="btnImport" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-emerald-200 hover:shadow-emerald-300 transition transform active:scale-95 flex items-center justify-center gap-2">
                        <span>Proses Import</span>
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // --- ALPINEJS DATA (SEARCH LOGIC) ---
    function targetManager() {
        return {
            searchQuery: '',
            // Logic Search: Show template if name matches OR show account if any template matches
            matchTemplate(name) {
                if (!this.searchQuery) return true;
                return name.toLowerCase().includes(this.searchQuery.toLowerCase());
            },
            matchAccount(phone, items) {
                if (!this.searchQuery) return true;
                const q = this.searchQuery.toLowerCase();
                // Match Account Phone OR Match ANY Template Name inside
                if (phone.includes(q)) return true;
                return Object.keys(items).some(tmpl => tmpl.toLowerCase().includes(q));
            }
        }
    }

    // --- VARIABLES ---
    let scannedGroups = [];
    let currentDetailTemplate = null; // Store current template being viewed for deletion

    // --- 1. DETAIL MODAL LOGIC (DRAWER) ---
    function viewDetails(tmplName, groups) {
        currentDetailTemplate = { name: tmplName, source: groups[0].source_phone }; // Store context
        
        const modal = document.getElementById('detailModal');
        const backdrop = document.getElementById('detailBackdrop');
        const panel = document.getElementById('detailPanel');
        const list = document.getElementById('detailList');
        
        document.getElementById('detailTitle').innerText = tmplName;
        document.getElementById('detailSubtitle').innerText = `${groups.length} Grup Tersimpan`;
        
        // Render List Item
        list.innerHTML = '';
        groups.forEach((g) => {
            let topicBadges = '';
            if(g.topic_ids) {
                g.topic_ids.split(',').forEach(t => {
                    topicBadges += `<span class="bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded text-[10px] font-mono border border-indigo-100 font-bold">#${t}</span>`;
                });
            } else {
                topicBadges = `<span class="text-[10px] text-slate-400 italic flex items-center gap-1"><i class="fa-solid fa-users"></i> General Chat</span>`;
            }

            const item = `
            <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex flex-col gap-3 group hover:border-indigo-300 transition-colors animate-fade-in">
                <div class="flex justify-between items-start gap-3">
                    <div class="min-w-0">
                        <h4 class="font-bold text-slate-800 text-sm truncate" title="${g.group_name}">${g.group_name}</h4>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-[10px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-500 font-mono border border-slate-200">${g.group_id}</span>
                        </div>
                    </div>
                    <button onclick="removeGroupFromList(this, '${g.id}')" class="w-8 h-8 rounded-lg bg-white border border-slate-100 text-slate-300 hover:text-red-500 hover:border-red-200 hover:bg-red-50 transition flex items-center justify-center shadow-sm">
                        <i class="fa-solid fa-trash-can text-xs"></i>
                    </button>
                </div>
                <div class="flex flex-wrap gap-1.5 pt-2 border-t border-slate-50">
                    ${topicBadges}
                </div>
            </div>`;
            list.innerHTML += item;
        });

        // Show Modal
        modal.classList.remove('hidden');
        setTimeout(() => {
            backdrop.classList.remove('opacity-0');
            panel.classList.remove('translate-x-full');
        }, 10);
    }

    function closeDetailModal() {
        const modal = document.getElementById('detailModal');
        const backdrop = document.getElementById('detailBackdrop');
        const panel = document.getElementById('detailPanel');
        
        backdrop.classList.add('opacity-0');
        panel.classList.add('translate-x-full');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    function removeGroupFromList(btn, id) {
        if(!confirm('Hapus grup ini dari template?')) return;
        // Call API Delete Target (Existing route)
        fetch(`/delete_target/${id}`).then(() => {
            btn.closest('.bg-white').remove(); // UI remove
            // Update counter visual if needed (optional)
        });
    }

    // --- 2. DELETE TEMPLATE LOGIC ---
    async function deleteTemplate(name, phone) {
        if(!confirm(`⚠️ PERINGATAN PENTING!\n\nAnda akan menghapus seluruh template "${name}".\nSemua grup di dalamnya akan hilang permanen dari database.\n\nLanjutkan?`)) return;
        
        try {
            const res = await fetch('/delete_target_template', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ template_name: name, source_phone: phone })
            });
            const d = await res.json();
            if(d.status === 'success') location.reload();
            else alert(d.message);
        } catch(e) {
            alert("Error: " + e);
        }
    }
    
    function deleteCurrentTemplate() {
        if(currentDetailTemplate) {
            deleteTemplate(currentDetailTemplate.name, currentDetailTemplate.source);
        }
    }

    // --- 3. SCAN MODAL LOGIC ---
    function openScanModal() {
        const m = document.getElementById('scanModal');
        m.classList.remove('hidden');
        setTimeout(() => {
            document.getElementById('scanBackdrop').classList.remove('opacity-0');
            document.getElementById('scanPanel').classList.remove('opacity-0', 'scale-95');
            document.getElementById('scanPanel').classList.add('opacity-100', 'scale-100');
        }, 10);
        
        // Reset State
        document.getElementById('initialState').classList.remove('hidden');
        document.getElementById('loadingScan').classList.add('hidden');
        document.getElementById('resultList').classList.add('hidden');
        document.getElementById('saveBar').classList.add('hidden');
        // Auto Generate Date Name
        const date = new Date();
        const dateStr = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
        document.getElementById('scanTemplateName').value = `Scan ${dateStr}`;
    }

    function closeScanModal() {
        document.getElementById('scanBackdrop').classList.add('opacity-0');
        document.getElementById('scanPanel').classList.remove('opacity-100', 'scale-100');
        document.getElementById('scanPanel').classList.add('opacity-0', 'scale-95');
        setTimeout(() => document.getElementById('scanModal').classList.add('hidden'), 300);
    }

    async function startScanning() {
        const phone = document.getElementById('scanAccountSelect').value;
        const tmpl = document.getElementById('scanTemplateName').value;
        
        if (!phone) return alert("Pilih akun sumber dulu!");
        if (!tmpl) return alert("Beri nama template dulu!");

        const init = document.getElementById('initialState');
        const load = document.getElementById('loadingScan');
        const list = document.getElementById('resultList');
        const saveBar = document.getElementById('saveBar');

        init.classList.add('hidden');
        load.classList.remove('hidden');

        try {
            const res = await fetch(`/scan_groups_api?phone=${encodeURIComponent(phone)}`);
            const data = await res.json();
            
            if(data.status === 'success') {
                scannedGroups = data.data;
                renderScanResults(scannedGroups);
                load.classList.add('hidden');
                list.classList.remove('hidden');
                saveBar.classList.remove('hidden');
                document.getElementById('saveBar').classList.add('flex'); // Enable flex
            } else {
                alert(data.message);
                init.classList.remove('hidden');
                load.classList.add('hidden');
            }
        } catch(e) {
            alert("Error: " + e);
            init.classList.remove('hidden');
            load.classList.add('hidden');
        }
    }

    function renderScanResults(groups) {
        const list = document.getElementById('resultList');
        list.innerHTML = '';
        
        if(groups.length === 0) {
            list.innerHTML = `<div class="col-span-full text-center py-10 text-slate-400">Tidak ada grup ditemukan.</div>`;
            return;
        }

        groups.forEach((g, idx) => {
            const html = `
            <div class="bg-white p-4 rounded-xl border border-slate-200 flex items-start gap-3 hover:border-indigo-300 transition-colors shadow-sm">
                <input type="checkbox" class="group-check form-checkbox w-5 h-5 text-indigo-600 rounded border-slate-300 focus:ring-indigo-500 cursor-pointer mt-0.5" value="${idx}" onchange="updateScanCount()">
                <div class="min-w-0">
                    <h4 class="font-bold text-slate-700 text-sm truncate">${g.name}</h4>
                    <p class="text-xs text-slate-400 font-mono">${g.id}</p>
                </div>
            </div>`;
            list.innerHTML += html;
        });
    }

    function updateScanCount() {
        const n = document.querySelectorAll('.group-check:checked').length;
        document.getElementById('selectedCountNum').innerText = n;
    }

    async function saveSelection() {
        const phone = document.getElementById('scanAccountSelect').value;
        const tmpl = document.getElementById('scanTemplateName').value;
        const checks = document.querySelectorAll('.group-check:checked');
        
        if (checks.length === 0) return alert("Pilih minimal satu grup!");

        const selected = [];
        checks.forEach(c => {
            const idx = c.value;
            const g = scannedGroups[idx];
            // Ambil semua topic ID jika ada
            const topicIds = g.topics ? g.topics.map(t => t.id) : [];
            
            selected.push({
                group_name: g.name,
                group_id: g.id,
                topic_ids: topicIds
            });
        });

        const btn = document.getElementById('btnSave');
        const oldText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Menyimpan...';

        try {
            const res = await fetch('/save_bulk_targets', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    targets: selected,
                    source_phone: phone,
                    template_name: tmpl // <-- KIRIM NAMA TEMPLATE
                })
            });
            const d = await res.json();
            if(d.status === 'success') {
                closeScanModal();
                location.reload();
            } else {
                throw new Error(d.message);
            }
        } catch(e) {
            alert("Gagal: " + e.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = oldText;
        }
    }

    // --- 4. IMPORT CSV MODAL ---
    function openImportModal() {
        const m = document.getElementById('importModal');
        const p = document.getElementById('importPanel');
        const b = document.getElementById('importBackdrop');
        
        m.classList.remove('hidden');
        setTimeout(() => {
            b.classList.remove('opacity-0');
            p.classList.remove('opacity-0', 'scale-95');
            p.classList.add('opacity-100', 'scale-100');
        }, 10);
    }

    function closeImportModal() {
        const m = document.getElementById('importModal');
        const p = document.getElementById('importPanel');
        const b = document.getElementById('importBackdrop');
        
        b.classList.add('opacity-0');
        p.classList.remove('opacity-100', 'scale-100');
        p.classList.add('opacity-0', 'scale-95');
        setTimeout(() => m.classList.add('hidden'), 300);
    }
    
    async function submitCsv(e) {
        e.preventDefault();
        const form = document.getElementById('csvForm');
        const btn = document.getElementById('btnImport');
        const fd = new FormData(form);
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Mengupload...';
        
        try {
            const res = await fetch('/import_targets_csv', {method: 'POST', body: fd});
            const d = await res.json();
            if(d.status === 'success') {
                alert(d.message);
                location.reload();
            } else {
                alert(d.message);
            }
        } catch(err) {
            alert("Error: " + err);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
    
    // --- 5. RENAME LOGIC (Placeholder) ---
    function promptRename(oldName, phone) {
        // Karena route API rename belum ada di python yang dikirim sebelumnya,
        // Kita bisa pake prompt JS sederhana dulu. 
        // Idealnya buat route /api/rename_template di app.py
        alert("Fitur Ganti Nama akan segera aktif setelah update backend!");
    }
</script>
{% endblock %}
