{% extends "dashboard/base.html" %}
{% block title %}Target Grup{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto animate-enter pb-20">
    
    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <div>
            <h1 class="text-3xl font-extrabold text-gray-900">Target Grup Blast</h1>
            <p class="text-gray-500 text-sm mt-1">Kelola daftar grup dan topik forum sasaran promosi.</p>
        </div>
        <button onclick="openScanModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 transition transform hover:-translate-y-1 flex items-center gap-2">
            <i class="fa-solid fa-radar"></i> Scan Grup Baru
        </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for t in targets %}
        <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm hover:shadow-md transition relative group">
            <div class="flex justify-between items-start">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center font-bold">
                        {{ t.group_name[:1] }}
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 line-clamp-1" title="{{ t.group_name }}">{{ t.group_name }}</h3>
                        <p class="text-xs text-gray-400">ID: {{ t.group_id }}</p>
                    </div>
                </div>
                <a href="/delete_target/{{ t.id }}" onclick="return confirm('Hapus target ini?')" class="text-gray-300 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></a>
            </div>
            
            {% if t.topic_ids %}
            <div class="mt-4 pt-3 border-t border-gray-50">
                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Target Topik (ID)</span>
                <div class="flex flex-wrap gap-1 mt-1">
                    {% for tid in t.topic_ids.split(',') %}
                    <span class="bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded text-[10px] font-mono font-bold">#{{ tid }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% else %}
        <div class="col-span-full py-20 text-center">
            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400">
                <i class="fa-solid fa-users-slash text-2xl"></i>
            </div>
            <p class="text-gray-500">Belum ada target grup tersimpan.</p>
        </div>
        {% endfor %}
    </div>
</div>

<div id="scanModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity opacity-0" id="modalBackdrop"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:w-full sm:max-w-2xl opacity-0 scale-95 flex flex-col max-h-[85vh]" id="modalPanel">
                
                <div class="bg-white px-6 py-4 border-b border-gray-100 flex justify-between items-center sticky top-0 z-20">
                    <h3 class="text-lg font-bold text-gray-900">Pilih Grup & Topik</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark fa-lg"></i></button>
                </div>

                <div class="p-6 overflow-y-auto custom-scrollbar flex-1" id="scanContent">
                    <div class="text-center py-10" id="loadingScan">
                        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-indigo-600 mb-4"></i>
                        <p class="text-gray-500">Sedang memindai grup Telegram Anda...</p>
                    </div>
                    <div id="resultList" class="space-y-4 hidden">
                        </div>
                </div>

                <div class="bg-gray-50 px-6 py-4 flex justify-between items-center border-t border-gray-100">
                    <span class="text-xs text-gray-500" id="selectedCount">0 Grup Dipilih</span>
                    <button onclick="saveSelection()" id="btnSave" class="bg-indigo-600 text-white px-6 py-2.5 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        Simpan Pilihan
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const modal = document.getElementById('scanModal');
    const backdrop = document.getElementById('modalBackdrop');
    const panel = document.getElementById('modalPanel');
    let scannedGroups = [];

    function openScanModal() {
        modal.classList.remove('hidden');
        setTimeout(() => {
            backdrop.classList.remove('opacity-0');
            panel.classList.remove('opacity-0', 'scale-95');
            panel.classList.add('opacity-100', 'scale-100');
        }, 10);
        startScanning();
    }

    function closeModal() {
        backdrop.classList.add('opacity-0');
        panel.classList.remove('opacity-100', 'scale-100');
        panel.classList.add('opacity-0', 'scale-95');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    async function startScanning() {
        document.getElementById('loadingScan').classList.remove('hidden');
        document.getElementById('resultList').classList.add('hidden');
        
        try {
            const res = await fetch('/scan_groups_api');
            const data = await res.json();
            
            if(data.status === 'success') {
                scannedGroups = data.data;
                renderGroups();
            } else {
                alert("Gagal scan: " + data.message);
                closeModal();
            }
        } catch(e) {
            alert("Koneksi error.");
            closeModal();
        } finally {
            document.getElementById('loadingScan').classList.add('hidden');
            document.getElementById('resultList').classList.remove('hidden');
        }
    }

    function renderGroups() {
        const list = document.getElementById('resultList');
        list.innerHTML = '';
        
        scannedGroups.forEach((g, index) => {
            const isForum = g.is_forum;
            let topicsHtml = '';

            // Jika Forum, render bagian Topik
            if(isForum) {
                let topicChecks = '';
                // Render Topik Otomatis
                g.topics.forEach(t => {
                    topicChecks += `
                    <label class="flex items-center gap-2 p-2 bg-white border border-gray-100 rounded-lg cursor-pointer hover:border-indigo-200 transition">
                        <input type="checkbox" class="topic-check-${index} form-checkbox h-3 w-3 text-indigo-600 rounded" value="${t.id}">
                        <span class="text-xs text-gray-600 truncate">${t.title}</span>
                    </label>`;
                });

                topicsHtml = `
                <div class="mt-3 ml-7 pl-4 border-l-2 border-indigo-100 hidden" id="topic-box-${index}">
                    <p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Pilih Topik (Opsional)</p>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        ${topicChecks || '<p class="text-xs text-gray-400 italic col-span-2">Tidak ada topik terdeteksi otomatis.</p>'}
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Input Manual ID (Pisahkan koma)</label>
                        <input type="text" id="manual-topic-${index}" placeholder="Contoh: 2, 45, 101" 
                               class="w-full mt-1 px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-xs focus:ring-1 focus:ring-indigo-500 outline-none font-mono">
                    </div>
                </div>`;
            }

            const item = document.createElement('div');
            item.className = "bg-gray-50 p-4 rounded-xl border border-gray-200 hover:border-indigo-300 transition";
            item.innerHTML = `
                <div class="flex items-center gap-3">
                    <input type="checkbox" class="group-check form-checkbox h-5 w-5 text-indigo-600 rounded-md border-gray-300 focus:ring-indigo-500" 
                           value="${index}" onchange="toggleTopics(${index})">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <h4 class="font-bold text-gray-800 text-sm">${g.name}</h4>
                            ${isForum ? '<span class="bg-yellow-100 text-yellow-700 text-[10px] px-1.5 py-0.5 rounded font-bold">FORUM</span>' : ''}
                        </div>
                        <p class="text-xs text-gray-400 font-mono">ID: ${g.id}</p>
                    </div>
                </div>
                ${topicsHtml}
            `;
            list.appendChild(item);
        });
    }

    function toggleTopics(index) {
        const box = document.getElementById(`topic-box-${index}`);
        if(box) {
            const checkbox = document.querySelector(`input[value="${index}"].group-check`);
            if(checkbox.checked) box.classList.remove('hidden');
            else box.classList.add('hidden');
        }
        updateCount();
    }

    function updateCount() {
        const count = document.querySelectorAll('.group-check:checked').length;
        document.getElementById('selectedCount').innerText = `${count} Grup Dipilih`;
    }

    async function saveSelection() {
        const btn = document.getElementById('btnSave');
        const selected = [];
        
        document.querySelectorAll('.group-check:checked').forEach(cb => {
            const idx = cb.value;
            const groupData = scannedGroups[idx];
            
            // Collect Topic IDs
            let topicIds = [];
            
            // 1. Dari Checkbox
            document.querySelectorAll(`.topic-check-${idx}:checked`).forEach(tc => {
                topicIds.push(parseInt(tc.value));
            });
            
            // 2. Dari Manual Input
            const manualInput = document.getElementById(`manual-topic-${idx}`);
            if(manualInput && manualInput.value) {
                const manuals = manualInput.value.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
                topicIds = [...topicIds, ...manuals];
            }

            // Remove duplicates
            topicIds = [...new Set(topicIds)];

            selected.push({
                group_name: groupData.name,
                group_id: groupData.id,
                topic_ids: topicIds // Kirim array ID Topik
            });
        });

        if(selected.length === 0) return alert("Pilih minimal satu grup!");

        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Menyimpan...';

        try {
            const res = await fetch('/save_bulk_targets', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({targets: selected})
            });
            const resp = await res.json();
            if(resp.status === 'success') {
                location.reload();
            } else {
                alert("Gagal simpan: " + resp.message);
                btn.disabled = false;
                btn.innerText = "Simpan Pilihan";
            }
        } catch(e) {
            alert("Error koneksi.");
            btn.disabled = false;
            btn.innerText = "Simpan Pilihan";
        }
    }
</script>
{% endblock %}
