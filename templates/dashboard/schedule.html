{% extends "dashboard/base.html" %}
{% block title %}Jadwal Share Otomatis{% endblock %}

{% block content %}
<style>
    .schedule-shell {
        color: var(--text-primary);
    }

    .schedule-card {
        background: var(--panel-bg);
        border: 1px solid var(--border-color);
        border-radius: 1.5rem;
    }

    .schedule-soft {
        background: var(--panel-muted);
        border: 1px solid var(--border-color);
        border-radius: 1rem;
    }

    .schedule-title,
    .schedule-heading {
        color: var(--text-primary);
    }

    .schedule-muted {
        color: var(--text-muted);
    }

    .schedule-input,
    .schedule-select {
        width: 100%;
        border: 1px solid var(--border-color);
        background: var(--panel-bg);
        color: var(--text-primary);
        border-radius: 0.9rem;
        transition: all .2s ease;
    }

    .schedule-input:focus,
    .schedule-select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 18%, transparent);
    }

    .hero-banner {
        background: linear-gradient(135deg, var(--panel-bg), var(--panel-muted));
        border: 1px solid var(--border-color);
        border-radius: 1.75rem;
    }

    .action-btn {
        border: 1px solid var(--border-color);
        background: var(--panel-bg);
        color: var(--text-muted);
    }

    .action-btn:hover {
        color: var(--accent);
        border-color: var(--accent);
    }
</style>

<div class="max-w-7xl mx-auto animate-fade-in pb-28 schedule-shell" x-data="scheduleManager()">
    <section class="hero-banner p-5 md:p-7 mb-6">
        <div class="flex flex-col md:flex-row md:items-center gap-4 md:justify-between">
            <div>
                <p class="text-xs font-semibold uppercase tracking-wider schedule-muted">Fitur Jadwal Share Grup</p>
                <h1 class="text-2xl md:text-3xl font-extrabold schedule-heading mt-1">Jadwalkan sekali, kirim otomatis setiap hari.</h1>
                <p class="text-sm schedule-muted mt-2 max-w-2xl">Bikin workflow share grup jadi lebih rapi untuk tim desktop maupun mobile. Pilih jam, akun pengirim, target folder, lalu biarkan sistem jalan sendiri.</p>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 w-full md:w-auto">
                <div class="schedule-soft p-3 min-w-[120px]">
                    <p class="text-[11px] font-semibold uppercase schedule-muted">Jadwal Aktif</p>
                    <p class="text-xl font-black schedule-title">{{ schedules|length }}</p>
                </div>
                <div class="schedule-soft p-3 min-w-[120px]">
                    <p class="text-[11px] font-semibold uppercase schedule-muted">Zona Waktu</p>
                    <p class="text-xl font-black schedule-title">WIB</p>
                </div>
                <div class="schedule-soft p-3 min-w-[120px] col-span-2 sm:col-span-1">
                    <p class="text-[11px] font-semibold uppercase schedule-muted">Status</p>
                    <p class="text-sm font-bold text-emerald-500">Auto-Pilot Aktif</p>
                </div>
            </div>
        </div>
    </section>

    <div class="grid grid-cols-1 xl:grid-cols-12 gap-6 items-start">
        <section class="xl:col-span-4 xl:sticky xl:top-6">
            <div class="schedule-card overflow-hidden shadow-soft">
                <div class="px-5 md:px-6 py-5 border-b" style="border-color: var(--border-color); background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 18%, var(--panel-bg)), var(--panel-bg));">
                    <h2 class="text-lg font-bold schedule-heading flex items-center gap-2"><i class="fa-solid fa-plus"></i> Buat Jadwal Baru</h2>
                    <p class="text-xs schedule-muted mt-1">Atur sekali dan biarkan bot share ke grup sesuai ritme harianmu.</p>
                </div>

                <form action="/add_schedule" method="POST" class="p-5 md:p-6 space-y-5">
                    <div class="schedule-soft p-4">
                        <label class="text-xs font-bold uppercase tracking-wide schedule-muted">Waktu Eksekusi (WIB)</label>
                        <div class="grid grid-cols-[1fr_auto_1fr] gap-2 mt-2 items-center">
                            <select name="hour" class="schedule-select px-3 py-3 text-xl font-black text-center font-mono" required>
                                {% for i in range(0, 24) %}
                                <option value="{{ i }}">{{ "%02d" % i }}</option>
                                {% endfor %}
                            </select>
                            <span class="font-black schedule-muted">:</span>
                            <input type="number" name="minute" min="0" max="59" value="00" class="schedule-input px-3 py-3 text-xl font-black text-center font-mono" required>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold uppercase tracking-wide schedule-muted">Akun Pengirim</label>
                        <select name="sender_phone" id="createSenderSelect" onchange="updateTargetOptions('create')" class="schedule-select px-4 py-3 mt-2 text-sm font-semibold">
                            <option value="auto">‚ö° Otomatis (Rotasi Akun)</option>
                            {% for acc in accounts %}
                                <option value="{{ acc.phone_number }}">{{ acc.first_name }} ({{ acc.phone_number }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="text-xs font-bold uppercase tracking-wide schedule-muted">Target Audiens (Folder)</label>
                        <select name="target_template_name" id="createTargetSelect" class="schedule-select px-4 py-3 mt-2 text-sm font-semibold"></select>
                    </div>

                    <div>
                        <div class="flex items-center justify-between gap-3">
                            <label class="text-xs font-bold uppercase tracking-wide schedule-muted">Template Pesan</label>
                            <a href="/dashboard/templates" class="text-xs font-semibold" style="color: var(--accent);">+ Kelola Template</a>
                        </div>
                        <select name="template_id" required class="schedule-select px-4 py-3 mt-2 text-sm font-semibold">
                            <option value="">-- Pilih Template --</option>
                            {% for t in templates %}
                            <option value="{{ t.id }}">{{ t.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <button type="submit" class="w-full rounded-xl px-4 py-3 font-bold text-white" style="background: var(--accent);">Simpan Jadwal & Aktifkan Otomatis</button>
                </form>
            </div>
        </section>

        <section class="xl:col-span-8 space-y-4">
            <div class="flex items-center justify-between gap-3">
                <h3 class="text-xl font-bold schedule-heading flex items-center gap-2"><i class="fa-regular fa-calendar-check"></i> Daftar Jadwal Aktif</h3>
                <span class="text-xs font-semibold uppercase tracking-wider schedule-muted">Desktop & Mobile Friendly</span>
            </div>

            {% if not schedules %}
            <div class="schedule-card p-10 text-center">
                <div class="w-16 h-16 mx-auto rounded-full flex items-center justify-center mb-4" style="background: var(--panel-muted); border: 1px solid var(--border-color);">
                    <i class="fa-solid fa-stopwatch text-2xl schedule-muted"></i>
                </div>
                <h4 class="text-lg font-bold schedule-title">Belum ada jadwal aktif</h4>
                <p class="text-sm schedule-muted mt-2">Mulai dari formulir di kiri, lalu sistem akan share otomatis setiap hari sesuai waktu yang kamu pilih.</p>
            </div>
            {% else %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for s in schedules %}
                <article class="schedule-card p-5 flex flex-col gap-4">
                    <div class="flex items-start justify-between gap-3">
                        <div>
                            <p class="text-3xl font-black font-mono schedule-title">{{ '%02d' % s.run_hour }}:{{ '%02d' % s.run_minute }} <span class="text-xs schedule-muted">WIB</span></p>
                            <p class="text-xs font-semibold text-emerald-500 mt-1">Berjalan harian</p>
                        </div>
                        <div class="flex gap-2">
                            <button type="button" onclick='openEditModal({{ s|tojson }})' class="action-btn w-9 h-9 rounded-lg flex items-center justify-center" title="Edit Jadwal">
                                <i class="fa-solid fa-pen-to-square text-sm"></i>
                            </button>
                            <a href="/delete_schedule/{{ s.id }}" onclick="return confirm('Hapus jadwal ini?')" class="action-btn w-9 h-9 rounded-lg flex items-center justify-center" title="Hapus Jadwal">
                                <i class="fa-solid fa-trash-can text-sm"></i>
                            </a>
                        </div>
                    </div>

                    <div class="schedule-soft p-3">
                        <p class="text-[11px] uppercase font-semibold schedule-muted">Pengirim</p>
                        <p class="text-sm font-bold schedule-title">
                            {% if s.sender_phone and s.sender_phone != 'auto' %}
                                {{ s.sender_phone }}
                            {% else %}
                                ‚ö° Auto Rotasi
                            {% endif %}
                        </p>
                    </div>

                    <div class="schedule-soft p-3">
                        <p class="text-[11px] uppercase font-semibold schedule-muted">Target Folder</p>
                        <p class="text-sm font-bold schedule-title">
                            {% if s.target_template_name %}
                                {{ s.target_template_name }}
                            {% else %}
                                üåç Semua Grup
                            {% endif %}
                        </p>
                    </div>

                    <div class="schedule-soft p-3">
                        <p class="text-[11px] uppercase font-semibold schedule-muted">Template Pesan</p>
                        <p class="text-sm font-bold schedule-title" title="ID: {{ s.template_id }}">
                            {% for t in templates %}
                                {% if t.id == s.template_id %}{{ t.name }}{% endif %}
                            {% endfor %}
                        </p>
                    </div>
                </article>
                {% endfor %}
            </div>
            {% endif %}
        </section>
    </div>
</div>

<div id="editModal" class="fixed inset-0 z-[100] hidden">
    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity opacity-0" id="editBackdrop" onclick="closeEditModal()"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
        <div class="schedule-card w-full max-w-lg transform scale-95 opacity-0 transition-all duration-300 relative overflow-hidden" id="editPanel">
            <form action="/update_schedule" method="POST" id="editForm">
                <input type="hidden" name="schedule_id" id="editScheduleId">

                <div class="px-6 py-5 border-b" style="border-color: var(--border-color); background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 18%, var(--panel-bg)), var(--panel-bg));">
                    <div class="flex items-center justify-between gap-3">
                        <h3 class="schedule-heading font-bold text-lg"><i class="fa-solid fa-pen-to-square"></i> Edit Jadwal</h3>
                        <button type="button" onclick="closeEditModal()" class="action-btn w-8 h-8 rounded-lg"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </div>

                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-xs font-bold uppercase schedule-muted mb-2">Waktu Eksekusi (WIB)</label>
                        <div class="grid grid-cols-[1fr_auto_1fr] gap-2 items-center">
                            <input type="number" name="hour" id="editHour" min="0" max="23" required class="schedule-input px-4 py-3 text-2xl font-black font-mono text-center">
                            <span class="font-black schedule-muted">:</span>
                            <input type="number" name="minute" id="editMinute" min="0" max="59" required class="schedule-input px-4 py-3 text-2xl font-black font-mono text-center">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold uppercase schedule-muted mb-2">Akun Pengirim</label>
                        <select name="sender_phone" id="editSenderSelect" onchange="updateTargetOptions('edit')" class="schedule-select px-4 py-3 text-sm font-semibold">
                            <option value="auto">‚ö° Otomatis (Rotasi)</option>
                            {% for acc in accounts %}
                                <option value="{{ acc.phone_number }}">{{ acc.first_name }} ({{ acc.phone_number }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold uppercase schedule-muted mb-2">Target Audiens (Folder)</label>
                        <select name="target_template_name" id="editTargetSelect" class="schedule-select px-4 py-3 text-sm font-semibold"></select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold uppercase schedule-muted mb-2">Template Pesan</label>
                        <select name="template_id" id="editTemplateSelect" required class="schedule-select px-4 py-3 text-sm font-semibold">
                            <option value="">-- Pilih Template --</option>
                            {% for t in templates %}
                                <option value="{{ t.id }}">{{ t.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="px-6 py-4 border-t flex justify-end gap-2" style="border-color: var(--border-color); background: var(--panel-muted);">
                    <button type="button" onclick="closeEditModal()" class="action-btn px-4 py-2 rounded-lg text-sm font-semibold">Batal</button>
                    <button type="submit" class="px-4 py-2 rounded-lg text-sm font-semibold text-white" style="background: var(--accent);">Update Jadwal</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const rawTargets = [
        {% for t in targets %}
        {
            id: "{{ t.id }}",
            group_name: "{{ t.group_name }}",
            template_name: "{{ t.template_name if t.template_name else 'Tanpa Nama' }}",
            source_phone: "{{ t.source_phone }}"
        },
        {% endfor %}
    ];

    function getGroupedTemplates(phoneFilter) {
        let groups = {};
        rawTargets.forEach(t => {
            if (phoneFilter && phoneFilter !== 'auto' && t.source_phone !== phoneFilter) return;

            let tmpl = t.template_name;
            if (!groups[tmpl]) {
                groups[tmpl] = { name: tmpl, count: 0 };
            }
            groups[tmpl].count++;
        });
        return Object.values(groups);
    }

    function updateTargetOptions(mode, preselectedValue = null) {
        const senderSelect = document.getElementById(mode + 'SenderSelect');
        const targetSelect = document.getElementById(mode + 'TargetSelect');
        const selectedPhone = senderSelect.value;

        targetSelect.innerHTML = '';

        let globalOpt = document.createElement('option');
        globalOpt.value = "";
        globalOpt.text = (selectedPhone === 'auto')
            ? "üåç Semua grup (Mode Auto)"
            : `üåç Semua grup dari ${selectedPhone}`;

        if (preselectedValue === "" || preselectedValue === null) {
            globalOpt.selected = true;
        }
        targetSelect.appendChild(globalOpt);

        const templates = getGroupedTemplates(selectedPhone);
        if (templates.length > 0) {
            templates.forEach(t => {
                let opt = document.createElement('option');
                opt.value = t.name;
                opt.text = `üìÇ Folder: ${t.name} (${t.count} Grup)`;

                if (preselectedValue === t.name) {
                    opt.selected = true;
                }
                targetSelect.appendChild(opt);
            });
        }
    }

    function openEditModal(scheduleData) {
        if (!scheduleData) return;

        const modal = document.getElementById('editModal');
        const backdrop = document.getElementById('editBackdrop');
        const panel = document.getElementById('editPanel');

        document.getElementById('editScheduleId').value = scheduleData.id;
        document.getElementById('editHour').value = scheduleData.run_hour.toString().padStart(2, '0');
        document.getElementById('editMinute').value = scheduleData.run_minute.toString().padStart(2, '0');

        const senderVal = (scheduleData.sender_phone && scheduleData.sender_phone !== 'auto')
                          ? scheduleData.sender_phone : 'auto';
        document.getElementById('editSenderSelect').value = senderVal;

        document.getElementById('editTemplateSelect').value = scheduleData.template_id || "";

        const savedTarget = scheduleData.target_template_name || "";
        updateTargetOptions('edit', savedTarget);

        modal.classList.remove('hidden');
        setTimeout(() => {
            backdrop.classList.remove('opacity-0');
            panel.classList.remove('opacity-0', 'scale-95');
            panel.classList.add('opacity-100', 'scale-100');
        }, 10);
    }

    function closeEditModal() {
        const modal = document.getElementById('editModal');
        const backdrop = document.getElementById('editBackdrop');
        const panel = document.getElementById('editPanel');

        backdrop.classList.add('opacity-0');
        panel.classList.remove('opacity-100', 'scale-100');
        panel.classList.add('opacity-0', 'scale-95');

        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateTargetOptions('create');
    });
</script>
{% endblock %}
