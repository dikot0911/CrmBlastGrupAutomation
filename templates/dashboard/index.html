{% extends "dashboard/base.html" %}
{% block title %}Ringkasan{% endblock %}

{% block content %}
<div class="space-y-6 sm:space-y-8">
    <section class="rounded-2xl border border-indigo-100/80 bg-gradient-to-r from-white via-indigo-50/50 to-purple-50/40 p-5 sm:p-7 shadow-soft animate-fade-in">
        <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
            <div>
                <span class="inline-flex items-center gap-2 rounded-full bg-indigo-100 px-3 py-1 text-[11px] font-semibold uppercase tracking-wider text-indigo-700">
                    <i class="fa-solid fa-wave-square"></i>
                    Dashboard Ringkasan
                </span>
                <h1 class="mt-3 text-2xl font-extrabold tracking-tight text-slate-800 sm:text-3xl">Ringkasan Aktivitas</h1>
                <p class="mt-2 max-w-2xl text-sm text-slate-500 sm:text-base">Lihat performa bot, jumlah target, CRM, dan histori pengiriman dalam tampilan yang nyaman untuk desktop maupun mobile.</p>
            </div>
            <div class="grid w-full gap-2 sm:max-w-xs">
                <div class="rounded-xl border border-indigo-100 bg-white/90 p-3 text-center shadow-sm">
                    <p class="text-[11px] font-semibold uppercase tracking-wider text-slate-400">Waktu Server (WIB)</p>
                    <div id="liveServerTime" class="mt-1 text-2xl font-bold text-indigo-600 font-mono">--:--:--</div>
                </div>
            </div>
        </div>
    </section>

    <section class="grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-4 animate-fade-in">
        <article class="rounded-2xl border border-indigo-100 bg-white p-5 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md">
            <div class="flex items-start justify-between gap-3">
                <div>
                    <p class="text-xs font-bold uppercase tracking-wider text-slate-400">Total Log</p>
                    <h3 class="mt-2 text-3xl font-extrabold text-slate-800">{{ total_logs if total_logs else logs|length }}</h3>
                    <p class="mt-1 text-xs text-slate-500">Semua rekam aktivitas</p>
                </div>
                <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-indigo-100 text-indigo-600"><i class="fa-solid fa-server"></i></span>
            </div>
        </article>

        <article class="rounded-2xl border border-purple-100 bg-white p-5 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md">
            <div class="flex items-start justify-between gap-3">
                <div>
                    <p class="text-xs font-bold uppercase tracking-wider text-slate-400">Target Grup</p>
                    <h3 class="mt-2 text-3xl font-extrabold text-slate-800">{{ targets|length }}</h3>
                    <p class="mt-1 text-xs text-slate-500">Grup aktif tersimpan</p>
                </div>
                <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-purple-100 text-purple-600"><i class="fa-solid fa-users-viewfinder"></i></span>
            </div>
        </article>

        <article class="rounded-2xl border border-blue-100 bg-white p-5 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md">
            <div class="flex items-start justify-between gap-3">
                <div>
                    <p class="text-xs font-bold uppercase tracking-wider text-slate-400">CRM User</p>
                    <h3 class="mt-2 text-3xl font-extrabold text-slate-800">{{ user_count }}</h3>
                    <p class="mt-1 text-xs text-slate-500">Kontak yang terdata</p>
                </div>
                <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-blue-100 text-blue-600"><i class="fa-solid fa-address-book"></i></span>
            </div>
        </article>

        <article class="rounded-2xl border border-amber-100 bg-white p-5 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md">
            <div class="flex items-start justify-between gap-3">
                <div>
                    <p class="text-xs font-bold uppercase tracking-wider text-slate-400">Jadwal</p>
                    <h3 class="mt-2 text-3xl font-extrabold text-slate-800">{{ schedules|length }}</h3>
                    <p class="mt-1 text-xs text-slate-500">Campaign terjadwal</p>
                </div>
                <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-amber-100 text-amber-600"><i class="fa-solid fa-clock"></i></span>
            </div>
        </article>
    </section>

    <section class="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm animate-fade-in">
        <div class="flex flex-col gap-3 border-b border-slate-200 bg-slate-50 px-4 py-4 sm:flex-row sm:items-center sm:justify-between sm:px-6">
            <div>
                <h3 class="text-base font-bold text-slate-800">Aktivitas Terakhir</h3>
                <p class="text-xs text-slate-500">Monitoring log pengiriman otomatis terbaru.</p>
            </div>
            <div class="flex items-center gap-2 sm:gap-3">
                <form action="{{ url_for('dashboard_overview') }}" method="get" class="flex items-center gap-2">
                    <label for="per_page" class="text-xs font-semibold text-slate-500">Baris:</label>
                    <select name="per_page" id="per_page" onchange="this.form.submit()" class="rounded-lg border border-slate-300 bg-white py-1.5 pl-2 pr-7 text-xs shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                        <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                        <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                    </select>
                </form>
                <button onclick="location.reload()" class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-300 bg-white text-slate-400 transition hover:border-indigo-200 hover:text-indigo-600" title="Refresh Data">
                    <i class="fa-solid fa-rotate-right"></i>
                </button>
            </div>
        </div>

        <div class="hidden md:block overflow-x-auto">
            <table class="min-w-full text-left text-sm">
                <thead class="bg-slate-50 text-xs font-bold uppercase tracking-wider text-slate-500">
                    <tr>
                        <th class="px-6 py-4">Waktu (WIB)</th>
                        <th class="px-6 py-4">Target</th>
                        <th class="px-6 py-4">Status</th>
                        <th class="px-6 py-4">Pesan Sistem</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    {% for log in logs %}
                    <tr class="transition hover:bg-indigo-50/30">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="rounded border border-slate-200 bg-slate-100 px-2 py-1 text-xs font-mono font-semibold text-slate-700">{{ log.wib_time if log.wib_time else log.created_at[11:19] }}</span>
                            <span class="mt-1 block text-[10px] font-mono text-slate-400">{{ log.wib_date if log.wib_date else log.created_at[:10] }}</span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="flex h-8 w-8 items-center justify-center rounded bg-indigo-100 text-xs font-bold uppercase text-indigo-700">{{ (log.group_name or log.target_name or '?')[0] }}</div>
                                <div class="max-w-[220px] truncate text-sm font-semibold text-slate-700" title="{{ log.group_name or log.target_name }}">{{ log.group_name or log.target_name }}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            {% if log.status|lower == 'success' or log.status|lower == 'berhasil' %}
                            <span class="inline-flex items-center gap-1.5 rounded-full border border-emerald-200 bg-emerald-50 px-2.5 py-1 text-[11px] font-bold text-emerald-600">
                                <span class="h-1.5 w-1.5 rounded-full bg-emerald-500"></span>BERHASIL
                            </span>
                            {% else %}
                            <span class="inline-flex items-center gap-1.5 rounded-full border border-rose-200 bg-rose-50 px-2.5 py-1 text-[11px] font-bold text-rose-600">
                                <span class="h-1.5 w-1.5 rounded-full bg-rose-500"></span>GAGAL
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-xs">
                            {% if log.status|lower == 'success' or log.status|lower == 'berhasil' %}
                            <span class="inline-flex items-center gap-1.5 text-slate-500"><i class="fa-solid fa-check-double text-emerald-500"></i> Terkirim tanpa error.</span>
                            {% else %}
                            <span class="block max-w-[320px] break-words rounded border border-rose-100 bg-rose-50 px-2 py-1 font-mono text-rose-500">{{ log.error_message or 'Unknown Error' }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="px-6 py-12 text-center text-slate-400">
                            <i class="fa-solid fa-inbox mb-3 block text-4xl opacity-25"></i>
                            Belum ada aktivitas tercatat.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="space-y-3 p-4 md:hidden">
            {% for log in logs %}
            <article class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
                <div class="flex items-start justify-between gap-3">
                    <div>
                        <p class="text-sm font-semibold text-slate-800">{{ log.group_name or log.target_name }}</p>
                        <p class="mt-1 text-[11px] font-mono text-slate-500">{{ log.wib_date if log.wib_date else log.created_at[:10] }} â€¢ {{ log.wib_time if log.wib_time else log.created_at[11:19] }}</p>
                    </div>
                    {% if log.status|lower == 'success' or log.status|lower == 'berhasil' %}
                    <span class="rounded-full border border-emerald-200 bg-emerald-50 px-2.5 py-1 text-[10px] font-bold text-emerald-600">BERHASIL</span>
                    {% else %}
                    <span class="rounded-full border border-rose-200 bg-rose-50 px-2.5 py-1 text-[10px] font-bold text-rose-600">GAGAL</span>
                    {% endif %}
                </div>
                <div class="mt-3 border-t border-slate-100 pt-3 text-xs">
                    {% if log.status|lower == 'success' or log.status|lower == 'berhasil' %}
                    <span class="text-slate-500"><i class="fa-solid fa-check-double text-emerald-500"></i> Terkirim tanpa error.</span>
                    {% else %}
                    <span class="block break-words rounded border border-rose-100 bg-rose-50 px-2 py-1 font-mono text-rose-500">{{ log.error_message or 'Unknown Error' }}</span>
                    {% endif %}
                </div>
            </article>
            {% else %}
            <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-10 text-center text-sm text-slate-400">
                <i class="fa-solid fa-inbox mb-3 block text-4xl opacity-20"></i>
                Belum ada aktivitas tercatat.
            </div>
            {% endfor %}
        </div>

        {% if total_pages > 1 %}
        <div class="flex flex-col gap-3 border-t border-slate-200 bg-slate-50 p-4 sm:flex-row sm:items-center sm:justify-between sm:px-6">
            <p class="text-xs text-slate-500">Halaman <span class="font-bold">{{ current_page }}</span> dari <span class="font-bold">{{ total_pages }}</span></p>
            <div class="flex gap-2">
                {% if current_page > 1 %}
                <a href="{{ url_for('dashboard_overview', page=current_page-1, per_page=per_page) }}" class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-xs font-semibold text-slate-600 transition hover:border-indigo-200 hover:text-indigo-600">
                    <i class="fa-solid fa-chevron-left mr-1.5"></i> Prev
                </a>
                {% endif %}
                {% if current_page < total_pages %}
                <a href="{{ url_for('dashboard_overview', page=current_page+1, per_page=per_page) }}" class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-xs font-semibold text-slate-600 transition hover:border-indigo-200 hover:text-indigo-600">
                    Next <i class="fa-solid fa-chevron-right ml-1.5"></i>
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    function updateServerClock() {
        const now = new Date();
        const options = {
            timeZone: 'Asia/Jakarta',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        };
        const timeString = now.toLocaleTimeString('id-ID', options).replace(/\./g, ':');
        const clockElement = document.getElementById('liveServerTime');
        if (clockElement) clockElement.innerText = timeString;
    }

    setInterval(updateServerClock, 1000);
    updateServerClock();
</script>
{% endblock %}
